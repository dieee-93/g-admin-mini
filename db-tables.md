-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.achievement_definitions (
  id character varying NOT NULL,
  name character varying NOT NULL,
  description text NOT NULL,
  icon character varying NOT NULL,
  domain character varying NOT NULL,
  trigger_event character varying NOT NULL,
  conditions jsonb NOT NULL,
  type character varying NOT NULL DEFAULT 'mastery'::character varying,
  tier character varying DEFAULT 'bronze'::character varying,
  points integer DEFAULT 0,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT achievement_definitions_pkey PRIMARY KEY (id)
);
CREATE TABLE public.afip_configuration (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  business_name character varying NOT NULL,
  tax_id character varying NOT NULL,
  certificate_path text,
  private_key_path text,
  environment text DEFAULT 'testing'::text CHECK (environment = ANY (ARRAY['testing'::text, 'production'::text])),
  punto_venta integer NOT NULL DEFAULT 1,
  is_active boolean DEFAULT true,
  last_used_number_a integer DEFAULT 0,
  last_used_number_b integer DEFAULT 0,
  last_used_number_c integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  location_id uuid UNIQUE,
  CONSTRAINT afip_configuration_pkey PRIMARY KEY (id),
  CONSTRAINT afip_configuration_location_id_fkey FOREIGN KEY (location_id) REFERENCES public.locations(id)
);
CREATE TABLE public.afip_configurations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  location_id uuid NOT NULL UNIQUE,
  cuit text NOT NULL,
  certificate_path text,
  private_key_path text,
  environment text DEFAULT 'testing'::text CHECK (environment = ANY (ARRAY['testing'::text, 'production'::text])),
  punto_venta integer NOT NULL,
  ultimo_comprobante integer DEFAULT 0,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT afip_configurations_pkey PRIMARY KEY (id),
  CONSTRAINT afip_configurations_location_id_fkey FOREIGN KEY (location_id) REFERENCES public.locations(id)
);
CREATE TABLE public.alerts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  type character varying NOT NULL CHECK (type::text = ANY (ARRAY['stock'::character varying, 'system'::character varying, 'validation'::character varying, 'business'::character varying, 'security'::character varying, 'operational'::character varying, 'achievement'::character varying]::text[])),
  severity character varying NOT NULL CHECK (severity::text = ANY (ARRAY['critical'::character varying, 'high'::character varying, 'medium'::character varying, 'low'::character varying, 'info'::character varying]::text[])),
  context character varying NOT NULL CHECK (context::text = ANY (ARRAY['dashboard'::character varying, 'global'::character varying, 'settings'::character varying, 'debug'::character varying, 'materials'::character varying, 'suppliers'::character varying, 'products'::character varying, 'production'::character varying, 'assets'::character varying, 'sales'::character varying, 'fulfillment'::character varying, 'mobile'::character varying, 'customers'::character varying, 'memberships'::character varying, 'rentals'::character varying, 'fiscal'::character varying, 'billing'::character varying, 'corporate'::character varying, 'integrations'::character varying, 'staff'::character varying, 'scheduling'::character varying, 'reporting'::character varying, 'intelligence'::character varying, 'executive'::character varying, 'gamification'::character varying, 'achievements'::character varying]::text[])),
  intelligence_level character varying NOT NULL DEFAULT 'simple'::character varying CHECK (intelligence_level::text = ANY (ARRAY['simple'::character varying, 'smart'::character varying, 'predictive'::character varying]::text[])),
  title text NOT NULL,
  description text,
  metadata jsonb DEFAULT '{}'::jsonb,
  status character varying NOT NULL DEFAULT 'active'::character varying CHECK (status::text = ANY (ARRAY['active'::character varying, 'acknowledged'::character varying, 'resolved'::character varying, 'dismissed'::character varying]::text[])),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  acknowledged_at timestamp with time zone,
  acknowledged_by uuid,
  resolved_at timestamp with time zone,
  resolved_by uuid,
  resolution_notes text,
  persistent boolean DEFAULT false,
  auto_expire_ms integer,
  escalation_level integer DEFAULT 0,
  is_recurring boolean DEFAULT false,
  recurrence_pattern text,
  occurrence_count integer DEFAULT 0,
  last_occurrence timestamp with time zone,
  confidence numeric,
  predicted_date timestamp with time zone,
  model_version character varying,
  CONSTRAINT alerts_pkey PRIMARY KEY (id),
  CONSTRAINT alerts_acknowledged_by_fkey FOREIGN KEY (acknowledged_by) REFERENCES auth.users(id),
  CONSTRAINT alerts_resolved_by_fkey FOREIGN KEY (resolved_by) REFERENCES auth.users(id)
);
CREATE TABLE public.appointment_slots (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  staff_id uuid NOT NULL,
  date date NOT NULL,
  start_time time without time zone NOT NULL,
  end_time time without time zone NOT NULL,
  status character varying DEFAULT 'available'::character varying CHECK (status::text = ANY (ARRAY['available'::character varying, 'booked'::character varying, 'blocked'::character varying]::text[])),
  appointment_id uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT appointment_slots_pkey PRIMARY KEY (id),
  CONSTRAINT appointment_slots_staff_id_fkey FOREIGN KEY (staff_id) REFERENCES public.employees(id),
  CONSTRAINT appointment_slots_appointment_id_fkey FOREIGN KEY (appointment_id) REFERENCES public.sales(id)
);
CREATE TABLE public.appointments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  customer_id uuid,
  customer_name text NOT NULL,
  customer_phone text,
  customer_email text,
  service_id uuid,
  service_name text NOT NULL,
  service_duration_minutes integer NOT NULL CHECK (service_duration_minutes > 0),
  provider_id uuid,
  provider_name text,
  appointment_date date NOT NULL CHECK (appointment_date >= (CURRENT_DATE - '1 day'::interval)),
  start_time time without time zone NOT NULL,
  end_time time without time zone NOT NULL,
  timezone text DEFAULT 'America/Argentina/Buenos_Aires'::text,
  status text NOT NULL DEFAULT 'scheduled'::text CHECK (status = ANY (ARRAY['scheduled'::text, 'confirmed'::text, 'in_progress'::text, 'completed'::text, 'no_show'::text, 'cancelled'::text])),
  booking_source text NOT NULL CHECK (booking_source = ANY (ARRAY['staff'::text, 'online'::text, 'walk_in'::text, 'phone'::text])),
  notes text,
  cancellation_reason text,
  reminder_sent_at timestamp with time zone,
  confirmation_sent_at timestamp with time zone,
  package_id uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  created_by uuid,
  cancelled_at timestamp with time zone,
  cancelled_by uuid,
  CONSTRAINT appointments_pkey PRIMARY KEY (id),
  CONSTRAINT appointments_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id),
  CONSTRAINT appointments_service_id_fkey FOREIGN KEY (service_id) REFERENCES public.products(id),
  CONSTRAINT appointments_provider_id_fkey FOREIGN KEY (provider_id) REFERENCES auth.users(id),
  CONSTRAINT appointments_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id),
  CONSTRAINT appointments_cancelled_by_fkey FOREIGN KEY (cancelled_by) REFERENCES auth.users(id),
  CONSTRAINT fk_appointments_package FOREIGN KEY (package_id) REFERENCES public.service_packages(id)
);
CREATE TABLE public.approval_steps (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  workflow_id uuid,
  level integer NOT NULL CHECK (level >= 1 AND level <= 4),
  approver_id uuid,
  status text NOT NULL DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'approved'::text, 'rejected'::text, 'escalated'::text])),
  comments text,
  approved_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT approval_steps_pkey PRIMARY KEY (id),
  CONSTRAINT approval_steps_workflow_id_fkey FOREIGN KEY (workflow_id) REFERENCES public.approval_workflows(id),
  CONSTRAINT approval_steps_approver_id_fkey FOREIGN KEY (approver_id) REFERENCES auth.users(id)
);
CREATE TABLE public.approval_workflows (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  entity_type text NOT NULL CHECK (entity_type = ANY (ARRAY['quote'::text, 'contract'::text, 'order'::text])),
  entity_id uuid NOT NULL,
  current_level integer NOT NULL DEFAULT 1 CHECK (current_level >= 1 AND current_level <= 4),
  required_level integer NOT NULL CHECK (required_level >= 1 AND required_level <= 4),
  status text NOT NULL DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'approved'::text, 'rejected'::text, 'escalated'::text])),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT approval_workflows_pkey PRIMARY KEY (id)
);
CREATE TABLE public.assets (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name character varying NOT NULL,
  asset_code character varying NOT NULL UNIQUE,
  description text,
  category character varying NOT NULL,
  status character varying NOT NULL DEFAULT 'available'::character varying,
  condition character varying NOT NULL DEFAULT 'good'::character varying,
  purchase_price numeric,
  current_value numeric,
  purchase_date date,
  location character varying,
  assigned_to uuid,
  is_rentable boolean DEFAULT false,
  rental_price_per_day numeric,
  rental_price_per_hour numeric,
  currently_rented boolean DEFAULT false,
  current_rental_id uuid,
  last_maintenance_date date,
  next_maintenance_date date,
  maintenance_interval_days integer DEFAULT 90,
  notes text,
  tags ARRAY,
  custom_fields jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  created_by uuid,
  updated_by uuid,
  CONSTRAINT assets_pkey PRIMARY KEY (id),
  CONSTRAINT assets_assigned_to_fkey FOREIGN KEY (assigned_to) REFERENCES public.employees(id)
);
CREATE TABLE public.async_update_queue (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  entity_type text NOT NULL CHECK (entity_type = ANY (ARRAY['order'::text, 'sale'::text, 'table'::text, 'party'::text])),
  entity_id uuid NOT NULL,
  update_type text NOT NULL CHECK (update_type = ANY (ARRAY['totals'::text, 'analytics'::text, 'performance'::text, 'metrics'::text])),
  priority smallint DEFAULT 5 CHECK (priority >= 1 AND priority <= 10),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  processed_at timestamp with time zone,
  CONSTRAINT async_update_queue_pkey PRIMARY KEY (id)
);
CREATE TABLE public.availability_exceptions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  staff_id uuid,
  location_id uuid,
  exception_date date NOT NULL,
  is_closed boolean DEFAULT true,
  custom_start_time time without time zone,
  custom_end_time time without time zone,
  reason text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT availability_exceptions_pkey PRIMARY KEY (id),
  CONSTRAINT availability_exceptions_staff_id_fkey FOREIGN KEY (staff_id) REFERENCES public.employees(id),
  CONSTRAINT availability_exceptions_location_id_fkey FOREIGN KEY (location_id) REFERENCES public.locations(id)
);
CREATE TABLE public.availability_rules (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  location_id uuid,
  day_of_week integer NOT NULL CHECK (day_of_week >= 0 AND day_of_week <= 6),
  start_time time without time zone NOT NULL,
  end_time time without time zone NOT NULL,
  is_active boolean DEFAULT true,
  min_advance_hours integer DEFAULT 2,
  max_advance_days integer DEFAULT 30,
  buffer_minutes integer DEFAULT 0,
  slot_duration_minutes integer DEFAULT 15,
  cancellation_policy character varying DEFAULT 'flexible'::character varying,
  cancellation_fee_percentage numeric DEFAULT 0.00,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT availability_rules_pkey PRIMARY KEY (id),
  CONSTRAINT availability_rules_location_id_fkey FOREIGN KEY (location_id) REFERENCES public.locations(id)
);
CREATE TABLE public.b2b_contracts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  contract_number text NOT NULL UNIQUE,
  customer_id uuid,
  corporate_account_id uuid,
  type text NOT NULL CHECK (type = ANY (ARRAY['fixed_term'::text, 'ongoing'::text, 'volume_based'::text, 'subscription'::text])),
  status text NOT NULL DEFAULT 'draft'::text CHECK (status = ANY (ARRAY['draft'::text, 'pending_signature'::text, 'active'::text, 'suspended'::text, 'expired'::text, 'terminated'::text])),
  start_date date NOT NULL,
  end_date date,
  renewal_terms text,
  payment_terms integer NOT NULL DEFAULT 30 CHECK (payment_terms >= 0 AND payment_terms <= 365),
  pricing_tier_id uuid,
  minimum_order_value numeric,
  minimum_order_quantity numeric,
  terms_and_conditions text NOT NULL,
  signed_by_customer text,
  signed_by_supplier text,
  signature_date timestamp with time zone,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT b2b_contracts_pkey PRIMARY KEY (id),
  CONSTRAINT b2b_contracts_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id),
  CONSTRAINT b2b_contracts_corporate_account_id_fkey FOREIGN KEY (corporate_account_id) REFERENCES public.corporate_accounts(id),
  CONSTRAINT b2b_contracts_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id)
);
CREATE TABLE public.b2b_quote_items (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  quote_id uuid,
  product_id uuid,
  product_name text NOT NULL,
  quantity numeric NOT NULL CHECK (quantity > 0::numeric),
  unit_price numeric NOT NULL CHECK (unit_price >= 0::numeric),
  tiered_price numeric,
  discount_percentage numeric DEFAULT 0.00 CHECK (discount_percentage >= 0::numeric AND discount_percentage <= 100::numeric),
  line_total numeric NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT b2b_quote_items_pkey PRIMARY KEY (id),
  CONSTRAINT b2b_quote_items_quote_id_fkey FOREIGN KEY (quote_id) REFERENCES public.b2b_quotes(id)
);
CREATE TABLE public.b2b_quotes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  quote_number text NOT NULL UNIQUE,
  customer_id uuid,
  corporate_account_id uuid,
  status text NOT NULL DEFAULT 'draft'::text CHECK (status = ANY (ARRAY['draft'::text, 'pending_approval'::text, 'approved'::text, 'sent'::text, 'accepted'::text, 'rejected'::text, 'expired'::text, 'converted'::text])),
  valid_until timestamp with time zone NOT NULL,
  subtotal numeric NOT NULL DEFAULT 0.00,
  discount_amount numeric NOT NULL DEFAULT 0.00,
  tax_amount numeric NOT NULL DEFAULT 0.00,
  total_amount numeric NOT NULL DEFAULT 0.00,
  notes text,
  terms_and_conditions text,
  created_by uuid,
  approved_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT b2b_quotes_pkey PRIMARY KEY (id),
  CONSTRAINT b2b_quotes_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id),
  CONSTRAINT b2b_quotes_corporate_account_id_fkey FOREIGN KEY (corporate_account_id) REFERENCES public.corporate_accounts(id),
  CONSTRAINT b2b_quotes_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id),
  CONSTRAINT b2b_quotes_approved_by_fkey FOREIGN KEY (approved_by) REFERENCES auth.users(id)
);
CREATE TABLE public.bill_splits (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  split_bill_id uuid NOT NULL,
  customer_name text,
  customer_phone character varying,
  customer_email character varying,
  amount numeric NOT NULL CHECK (amount > 0::numeric),
  tip_amount numeric NOT NULL DEFAULT 0.00,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'paid'::text, 'failed'::text, 'cancelled'::text])),
  assigned_items ARRAY DEFAULT '{}'::uuid[],
  custom_percentage numeric CHECK (custom_percentage >= 0::numeric AND custom_percentage <= 100::numeric),
  payment_method_id uuid,
  paid_at timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT bill_splits_pkey PRIMARY KEY (id),
  CONSTRAINT bill_splits_split_bill_id_fkey FOREIGN KEY (split_bill_id) REFERENCES public.split_bills(id),
  CONSTRAINT bill_splits_payment_method_id_fkey FOREIGN KEY (payment_method_id) REFERENCES public.payment_methods(id)
);
CREATE TABLE public.billing_cycles (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  subscription_id uuid NOT NULL,
  invoice_id uuid,
  cycle_number integer NOT NULL,
  start_date date NOT NULL,
  end_date date NOT NULL,
  due_date date NOT NULL,
  amount numeric NOT NULL,
  status text NOT NULL DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'invoiced'::text, 'paid'::text, 'overdue'::text, 'cancelled'::text])),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT billing_cycles_pkey PRIMARY KEY (id),
  CONSTRAINT billing_cycles_subscription_id_fkey FOREIGN KEY (subscription_id) REFERENCES public.subscriptions(id),
  CONSTRAINT fk_billing_cycles_invoice_id FOREIGN KEY (invoice_id) REFERENCES public.invoices(id)
);
CREATE TABLE public.business_profiles (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid,
  business_name text NOT NULL,
  business_type text,
  email text,
  phone text,
  country text DEFAULT 'Argentina'::text,
  currency text DEFAULT 'ARS'::text,
  active_capabilities jsonb NOT NULL DEFAULT '[]'::jsonb,
  business_structure text DEFAULT 'single_location'::text,
  computed_configuration jsonb DEFAULT '{}'::jsonb,
  auto_resolved_capabilities jsonb DEFAULT '[]'::jsonb,
  setup_completed boolean DEFAULT false,
  onboarding_step integer DEFAULT 0,
  setup_completed_at timestamp with time zone,
  created_by uuid,
  updated_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  selected_activities jsonb NOT NULL DEFAULT '[]'::jsonb,
  selected_infrastructure jsonb NOT NULL DEFAULT '["single_location"]'::jsonb,
  completed_milestones jsonb NOT NULL DEFAULT '[]'::jsonb,
  is_first_time_dashboard boolean DEFAULT true,
  CONSTRAINT business_profiles_pkey PRIMARY KEY (id),
  CONSTRAINT business_profiles_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id),
  CONSTRAINT business_profiles_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES auth.users(id)
);
CREATE TABLE public.carts (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  customer_id uuid,
  session_id character varying UNIQUE,
  location_id uuid,
  items jsonb NOT NULL DEFAULT '[]'::jsonb,
  subtotal numeric DEFAULT 0,
  tax numeric DEFAULT 0,
  total numeric DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  expires_at timestamp with time zone DEFAULT (now() + '7 days'::interval),
  CONSTRAINT carts_pkey PRIMARY KEY (id),
  CONSTRAINT carts_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id),
  CONSTRAINT carts_location_id_fkey FOREIGN KEY (location_id) REFERENCES public.locations(id)
);
CREATE TABLE public.cash_sessions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  money_location_id uuid NOT NULL,
  location_id uuid,
  opened_by uuid NOT NULL,
  closed_by uuid,
  opened_at timestamp with time zone NOT NULL DEFAULT now(),
  closed_at timestamp with time zone,
  starting_cash numeric NOT NULL,
  cash_sales numeric DEFAULT 0,
  cash_refunds numeric DEFAULT 0,
  cash_in numeric DEFAULT 0,
  cash_out numeric DEFAULT 0,
  cash_drops numeric DEFAULT 0,
  expected_cash numeric,
  actual_cash numeric,
  variance numeric,
  status text NOT NULL DEFAULT 'OPEN'::text CHECK (status = ANY (ARRAY['OPEN'::text, 'CLOSED'::text, 'AUDITED'::text, 'DISCREPANCY'::text])),
  opening_notes text,
  closing_notes text,
  audit_notes text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  employee_id uuid,
  shift_id uuid,
  approved_by uuid,
  net_cash numeric DEFAULT (cash_sales + cash_refunds),
  CONSTRAINT cash_sessions_pkey PRIMARY KEY (id),
  CONSTRAINT cash_sessions_closed_by_fkey FOREIGN KEY (closed_by) REFERENCES auth.users(id),
  CONSTRAINT cash_sessions_money_location_id_fkey FOREIGN KEY (money_location_id) REFERENCES public.money_locations(id),
  CONSTRAINT cash_sessions_location_id_fkey FOREIGN KEY (location_id) REFERENCES public.locations(id),
  CONSTRAINT cash_sessions_opened_by_fkey FOREIGN KEY (opened_by) REFERENCES auth.users(id),
  CONSTRAINT cash_sessions_employee_id_fkey FOREIGN KEY (employee_id) REFERENCES public.employees(id),
  CONSTRAINT cash_sessions_shift_id_fkey FOREIGN KEY (shift_id) REFERENCES public.operational_shifts(id),
  CONSTRAINT cash_sessions_approved_by_fkey FOREIGN KEY (approved_by) REFERENCES auth.users(id)
);
CREATE TABLE public.catalog_products (
  catalog_id uuid NOT NULL,
  product_id uuid NOT NULL,
  sort_order integer DEFAULT 0,
  is_featured boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT catalog_products_pkey PRIMARY KEY (catalog_id, product_id),
  CONSTRAINT catalog_products_catalog_id_fkey FOREIGN KEY (catalog_id) REFERENCES public.catalogs(id),
  CONSTRAINT catalog_products_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(id)
);
CREATE TABLE public.catalogs (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  name character varying NOT NULL,
  description text,
  type character varying DEFAULT 'default'::character varying,
  is_active boolean DEFAULT true,
  is_default boolean DEFAULT false,
  filters jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  created_by uuid,
  CONSTRAINT catalogs_pkey PRIMARY KEY (id),
  CONSTRAINT catalogs_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id)
);
CREATE TABLE public.categories (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name character varying NOT NULL UNIQUE,
  description text,
  color character varying,
  icon character varying,
  sort_order integer DEFAULT 0,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT categories_pkey PRIMARY KEY (id)
);
CREATE TABLE public.chart_of_accounts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  parent_id uuid,
  code character varying NOT NULL UNIQUE,
  name text NOT NULL,
  account_type text NOT NULL CHECK (account_type = ANY (ARRAY['ASSET'::text, 'LIABILITY'::text, 'EQUITY'::text, 'INCOME'::text, 'EXPENSE'::text])),
  sub_type text,
  is_group boolean DEFAULT false,
  is_active boolean DEFAULT true,
  normal_balance text NOT NULL CHECK (normal_balance = ANY (ARRAY['DEBIT'::text, 'CREDIT'::text])),
  allow_transactions boolean DEFAULT true,
  description text,
  currency text DEFAULT 'ARS'::text,
  location_id uuid,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  created_by uuid,
  updated_by uuid,
  CONSTRAINT chart_of_accounts_pkey PRIMARY KEY (id),
  CONSTRAINT chart_of_accounts_parent_id_fkey FOREIGN KEY (parent_id) REFERENCES public.chart_of_accounts(id),
  CONSTRAINT chart_of_accounts_location_id_fkey FOREIGN KEY (location_id) REFERENCES public.locations(id),
  CONSTRAINT chart_of_accounts_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id),
  CONSTRAINT chart_of_accounts_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES auth.users(id)
);
CREATE TABLE public.corporate_accounts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  customer_id uuid,
  credit_limit numeric DEFAULT 0.00,
  current_balance numeric DEFAULT 0.00,
  payment_terms integer DEFAULT 30,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT corporate_accounts_pkey PRIMARY KEY (id),
  CONSTRAINT corporate_accounts_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id)
);
CREATE TABLE public.customer_addresses (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  customer_id uuid NOT NULL,
  label character varying NOT NULL DEFAULT 'Casa'::character varying,
  address_line_1 text NOT NULL,
  address_line_2 text,
  city character varying DEFAULT 'Buenos Aires'::character varying,
  state character varying DEFAULT 'CABA'::character varying,
  postal_code character varying,
  country character varying DEFAULT 'Argentina'::character varying,
  latitude numeric,
  longitude numeric,
  formatted_address text,
  delivery_instructions text,
  is_default boolean DEFAULT false,
  is_verified boolean DEFAULT false,
  last_used_at timestamp with time zone,
  usage_count integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT customer_addresses_pkey PRIMARY KEY (id),
  CONSTRAINT customer_addresses_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id)
);
CREATE TABLE public.customer_packages (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  customer_id uuid NOT NULL,
  package_id uuid NOT NULL,
  purchased_at timestamp with time zone DEFAULT now(),
  purchased_by uuid,
  sessions_remaining integer NOT NULL CHECK (sessions_remaining >= 0),
  sessions_used integer DEFAULT 0 CHECK (sessions_used >= 0),
  expires_at timestamp with time zone,
  payment_status text NOT NULL DEFAULT 'pending'::text CHECK (payment_status = ANY (ARRAY['pending'::text, 'paid'::text, 'refunded'::text])),
  amount_paid numeric NOT NULL CHECK (amount_paid >= 0::numeric),
  status text NOT NULL DEFAULT 'active'::text CHECK (status = ANY (ARRAY['active'::text, 'expired'::text, 'completed'::text, 'cancelled'::text])),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT customer_packages_pkey PRIMARY KEY (id),
  CONSTRAINT customer_packages_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id),
  CONSTRAINT customer_packages_package_id_fkey FOREIGN KEY (package_id) REFERENCES public.service_packages(id),
  CONSTRAINT customer_packages_purchased_by_fkey FOREIGN KEY (purchased_by) REFERENCES auth.users(id)
);
CREATE TABLE public.customer_rfm_profiles (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  customer_id bigint UNIQUE,
  rfm_segment text,
  churn_risk text CHECK (churn_risk = ANY (ARRAY['low'::text, 'medium'::text, 'high'::text])),
  recency_days integer,
  lifetime_value numeric,
  last_purchase_date date,
  avg_order_value numeric,
  visit_frequency numeric,
  is_vip boolean DEFAULT false,
  frequency_count integer,
  loyalty_tier text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT customer_rfm_profiles_pkey PRIMARY KEY (id)
);
CREATE TABLE public.customer_rfm_update_queue (
  customer_id uuid NOT NULL,
  queued_at timestamp with time zone DEFAULT now(),
  CONSTRAINT customer_rfm_update_queue_pkey PRIMARY KEY (customer_id)
);
CREATE TABLE public.customer_update_log (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  table_name text NOT NULL,
  record_id uuid NOT NULL,
  updated_at timestamp with time zone DEFAULT now(),
  updated_columns jsonb,
  CONSTRAINT customer_update_log_pkey PRIMARY KEY (id)
);
CREATE TABLE public.customers (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name character varying NOT NULL,
  email character varying,
  phone character varying,
  dni character varying,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  password_hash character varying,
  email_verified boolean DEFAULT false,
  email_verification_token character varying,
  password_reset_token character varying,
  password_reset_expires timestamp with time zone,
  created_via character varying DEFAULT 'admin'::character varying,
  is_active boolean NOT NULL DEFAULT true,
  mobile character varying,
  CONSTRAINT customers_pkey PRIMARY KEY (id)
);
CREATE TABLE public.daily_analytics (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  date date NOT NULL UNIQUE,
  total_revenue numeric NOT NULL DEFAULT 0.00,
  total_orders integer NOT NULL DEFAULT 0,
  average_order_value numeric NOT NULL DEFAULT 0.00,
  total_covers integer NOT NULL DEFAULT 0,
  table_turnover_rate numeric NOT NULL DEFAULT 0.00,
  average_service_time interval DEFAULT '01:30:00'::interval,
  customer_satisfaction_avg numeric NOT NULL DEFAULT 0.0,
  total_tips numeric NOT NULL DEFAULT 0.00,
  total_discounts numeric NOT NULL DEFAULT 0.00,
  refund_amount numeric NOT NULL DEFAULT 0.00,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT daily_analytics_pkey PRIMARY KEY (id)
);
CREATE TABLE public.deliveries (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  order_id text NOT NULL,
  delivery_address text NOT NULL,
  driver_id uuid,
  driver_name text,
  vehicle_id text,
  delivery_zone text,
  distance_km numeric,
  estimated_time_minutes integer,
  tracking_url text,
  scheduled_date date NOT NULL,
  scheduled_start_time time without time zone NOT NULL,
  scheduled_end_time time without time zone NOT NULL,
  status text DEFAULT 'scheduled'::text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT deliveries_pkey PRIMARY KEY (id),
  CONSTRAINT deliveries_driver_id_fkey FOREIGN KEY (driver_id) REFERENCES public.employees(id)
);
CREATE TABLE public.delivery_assignments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  queue_id uuid NOT NULL,
  driver_id uuid NOT NULL,
  zone_id uuid,
  status text NOT NULL DEFAULT 'assigned'::text CHECK (status = ANY (ARRAY['assigned'::text, 'accepted'::text, 'picked_up'::text, 'in_transit'::text, 'arrived'::text, 'delivered'::text, 'failed'::text, 'returned'::text])),
  estimated_distance_km numeric,
  estimated_duration_minutes integer,
  actual_distance_km numeric,
  actual_duration_minutes integer,
  assigned_at timestamp with time zone NOT NULL DEFAULT now(),
  accepted_at timestamp with time zone,
  picked_up_at timestamp with time zone,
  in_transit_at timestamp with time zone,
  arrived_at timestamp with time zone,
  delivered_at timestamp with time zone,
  failed_at timestamp with time zone,
  on_time boolean,
  customer_rating integer CHECK (customer_rating >= 1 AND customer_rating <= 5),
  customer_feedback text,
  failure_reason text,
  failure_notes text,
  notes text,
  metadata jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone,
  deleted_at timestamp with time zone,
  CONSTRAINT delivery_assignments_pkey PRIMARY KEY (id),
  CONSTRAINT delivery_assignments_queue_id_fkey FOREIGN KEY (queue_id) REFERENCES public.fulfillment_queue(id),
  CONSTRAINT delivery_assignments_driver_id_fkey FOREIGN KEY (driver_id) REFERENCES auth.users(id),
  CONSTRAINT delivery_assignments_zone_id_fkey FOREIGN KEY (zone_id) REFERENCES public.delivery_zones(id)
);
CREATE TABLE public.delivery_events (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  delivery_id uuid NOT NULL,
  driver_id uuid,
  event_type text NOT NULL CHECK (event_type = ANY (ARRAY['created'::text, 'assigned'::text, 'pickup'::text, 'in_transit'::text, 'arrived'::text, 'delivered'::text, 'cancelled'::text, 'failed'::text, 'status_update'::text])),
  old_status text,
  new_status text,
  lat numeric,
  lng numeric,
  notes text,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT delivery_events_pkey PRIMARY KEY (id),
  CONSTRAINT delivery_events_delivery_id_fkey FOREIGN KEY (delivery_id) REFERENCES public.delivery_orders(id),
  CONSTRAINT delivery_events_driver_id_fkey FOREIGN KEY (driver_id) REFERENCES public.employees(id)
);
CREATE TABLE public.delivery_orders (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  sale_id uuid NOT NULL,
  order_id uuid,
  customer_id uuid,
  driver_id uuid,
  zone_id uuid,
  customer_name text NOT NULL,
  customer_phone text,
  delivery_address text NOT NULL,
  delivery_lat numeric,
  delivery_lng numeric,
  delivery_instructions text,
  status text NOT NULL DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'assigned'::text, 'picked_up'::text, 'in_transit'::text, 'arrived'::text, 'delivered'::text, 'cancelled'::text, 'failed'::text])),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  scheduled_delivery_time timestamp with time zone,
  assigned_at timestamp with time zone,
  pickup_time timestamp with time zone,
  estimated_arrival_time timestamp with time zone,
  actual_delivery_time timestamp with time zone,
  updated_at timestamp with time zone,
  distance_km numeric,
  estimated_duration_minutes integer,
  current_lat numeric,
  current_lng numeric,
  items jsonb NOT NULL DEFAULT '[]'::jsonb,
  total numeric NOT NULL,
  notes text,
  priority text NOT NULL DEFAULT 'normal'::text CHECK (priority = ANY (ARRAY['normal'::text, 'rush'::text, 'vip'::text])),
  delivery_type text NOT NULL DEFAULT 'instant'::text CHECK (delivery_type = ANY (ARRAY['instant'::text, 'same_day'::text, 'scheduled'::text])),
  signature_url text,
  photo_url text,
  received_by text,
  customer_address_id uuid,
  delivery_latitude numeric,
  delivery_longitude numeric,
  CONSTRAINT delivery_orders_pkey PRIMARY KEY (id),
  CONSTRAINT delivery_orders_customer_address_id_fkey FOREIGN KEY (customer_address_id) REFERENCES public.customer_addresses(id),
  CONSTRAINT delivery_orders_sale_id_fkey FOREIGN KEY (sale_id) REFERENCES public.sales(id),
  CONSTRAINT delivery_orders_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id),
  CONSTRAINT delivery_orders_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id),
  CONSTRAINT delivery_orders_driver_id_fkey FOREIGN KEY (driver_id) REFERENCES public.employees(id),
  CONSTRAINT delivery_orders_zone_id_fkey FOREIGN KEY (zone_id) REFERENCES public.delivery_zones(id)
);
CREATE TABLE public.delivery_routes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  delivery_id uuid NOT NULL,
  origin_lat numeric NOT NULL,
  origin_lng numeric NOT NULL,
  destination_lat numeric NOT NULL,
  destination_lng numeric NOT NULL,
  waypoints jsonb DEFAULT '[]'::jsonb,
  optimized_path jsonb NOT NULL DEFAULT '[]'::jsonb,
  distance_km numeric NOT NULL,
  estimated_duration_minutes integer NOT NULL,
  actual_duration_minutes integer,
  optimization_algorithm text DEFAULT 'google_maps'::text,
  traffic_factor numeric DEFAULT 1.0,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  completed_at timestamp with time zone,
  CONSTRAINT delivery_routes_pkey PRIMARY KEY (id),
  CONSTRAINT delivery_routes_delivery_id_fkey FOREIGN KEY (delivery_id) REFERENCES public.delivery_orders(id)
);
CREATE TABLE public.delivery_zones (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL UNIQUE,
  description text,
  boundaries jsonb NOT NULL,
  center_lat numeric,
  center_lng numeric,
  delivery_fee numeric NOT NULL DEFAULT 0,
  estimated_time_minutes integer NOT NULL DEFAULT 45,
  min_order_amount numeric DEFAULT 0,
  color text NOT NULL DEFAULT '#3b82f6'::text,
  priority integer DEFAULT 0,
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone,
  deleted_at timestamp with time zone,
  location_id uuid,
  CONSTRAINT delivery_zones_pkey PRIMARY KEY (id),
  CONSTRAINT delivery_zones_location_id_fkey FOREIGN KEY (location_id) REFERENCES public.locations(id)
);
CREATE TABLE public.driver_locations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  driver_id uuid NOT NULL,
  delivery_id uuid,
  lat numeric NOT NULL,
  lng numeric NOT NULL,
  heading integer CHECK (heading >= 0 AND heading <= 360),
  speed_kmh numeric,
  accuracy_meters numeric,
  timestamp timestamp with time zone NOT NULL DEFAULT now(),
  battery_level integer CHECK (battery_level >= 0 AND battery_level <= 100),
  is_online boolean DEFAULT true,
  CONSTRAINT driver_locations_pkey PRIMARY KEY (id),
  CONSTRAINT driver_locations_driver_id_fkey FOREIGN KEY (driver_id) REFERENCES public.employees(id),
  CONSTRAINT driver_locations_delivery_id_fkey FOREIGN KEY (delivery_id) REFERENCES public.delivery_orders(id)
);
CREATE TABLE public.employee_availability (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  employee_id uuid NOT NULL,
  day_of_week integer NOT NULL CHECK (day_of_week >= 0 AND day_of_week <= 6),
  start_time time without time zone NOT NULL,
  end_time time without time zone NOT NULL,
  is_available boolean DEFAULT true,
  preference_level text DEFAULT 'neutral'::text CHECK (preference_level = ANY (ARRAY['preferred'::text, 'neutral'::text, 'avoid'::text, 'unavailable'::text])),
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT employee_availability_pkey PRIMARY KEY (id),
  CONSTRAINT employee_availability_employee_id_fkey FOREIGN KEY (employee_id) REFERENCES public.employees(id)
);
CREATE TABLE public.employee_skills (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  employee_id uuid NOT NULL,
  skill_name character varying NOT NULL,
  proficiency_level text DEFAULT 'intermediate'::text CHECK (proficiency_level = ANY (ARRAY['beginner'::text, 'intermediate'::text, 'advanced'::text, 'expert'::text])),
  certified boolean DEFAULT false,
  certification_date date,
  expiry_date date,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT employee_skills_pkey PRIMARY KEY (id),
  CONSTRAINT employee_skills_employee_id_fkey FOREIGN KEY (employee_id) REFERENCES public.employees(id)
);
CREATE TABLE public.employee_training (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  employee_id uuid NOT NULL,
  training_name text NOT NULL,
  completed_date date NOT NULL,
  expiry_date date,
  issuing_authority text,
  certificate_url text,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  created_by uuid,
  training_type USER-DEFINED NOT NULL,
  CONSTRAINT employee_training_pkey PRIMARY KEY (id),
  CONSTRAINT employee_training_employee_id_fkey FOREIGN KEY (employee_id) REFERENCES public.employees(id),
  CONSTRAINT employee_training_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id)
);
CREATE TABLE public.employees (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  first_name character varying NOT NULL,
  last_name character varying NOT NULL,
  name character varying DEFAULT (((first_name)::text || ' '::text) || (last_name)::text),
  email character varying UNIQUE,
  phone character varying,
  position character varying NOT NULL,
  department character varying CHECK (department::text = ANY (ARRAY['Cocina'::character varying, 'Servicio'::character varying, 'AdministraciÃ³n'::character varying, 'Caja'::character varying, 'Limpieza'::character varying, 'Gerencia'::character varying, 'Delivery'::character varying]::text[])),
  employment_status text DEFAULT 'active'::text CHECK (employment_status = ANY (ARRAY['active'::text, 'inactive'::text, 'terminated'::text, 'on_leave'::text])),
  status text DEFAULT 'active'::text CHECK (status = ANY (ARRAY['active'::text, 'inactive'::text])),
  hire_date date DEFAULT CURRENT_DATE,
  salary numeric DEFAULT 0,
  hourly_rate numeric DEFAULT 0,
  weekly_hours integer DEFAULT 40,
  performance_score numeric DEFAULT 0,
  attendance_rate numeric DEFAULT 100,
  availability jsonb DEFAULT '{}'::jsonb,
  skills ARRAY DEFAULT '{}'::text[],
  certifications ARRAY DEFAULT '{}'::text[],
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  is_available boolean DEFAULT false,
  vehicle_type text CHECK (vehicle_type = ANY (ARRAY['car'::text, 'motorcycle'::text, 'bicycle'::text, 'scooter'::text, NULL::text])),
  license_number text,
  driver_rating numeric DEFAULT 5.00 CHECK (driver_rating >= 0::numeric AND driver_rating <= 5::numeric),
  total_deliveries integer DEFAULT 0 CHECK (total_deliveries >= 0),
  home_location_id uuid,
  can_work_multiple_locations boolean NOT NULL DEFAULT false,
  accepts_appointments boolean DEFAULT false,
  services_provided ARRAY DEFAULT '{}'::uuid[],
  booking_buffer_minutes integer DEFAULT 15,
  allow_online_booking boolean DEFAULT true,
  max_appointments_per_day integer DEFAULT 8,
  appointment_notes text,
  professional_bio text,
  years_of_experience integer,
  avatar_url text,
  shift_preference USER-DEFINED DEFAULT 'flexible'::shift_preference_enum,
  training_completed ARRAY DEFAULT '{}'::text[],
  completed_tasks integer DEFAULT 0,
  available_days ARRAY DEFAULT '{monday,tuesday,wednesday,thursday,friday}'::text[],
  checked_in boolean DEFAULT false,
  checked_in_at timestamp with time zone,
  CONSTRAINT employees_pkey PRIMARY KEY (id),
  CONSTRAINT employees_home_location_id_fkey FOREIGN KEY (home_location_id) REFERENCES public.locations(id)
);
CREATE TABLE public.financial_reports (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  report_name character varying NOT NULL,
  report_type text NOT NULL CHECK (report_type = ANY (ARRAY['balance'::text, 'income_statement'::text, 'cash_flow'::text, 'tax_summary'::text])),
  start_date date NOT NULL,
  end_date date NOT NULL,
  data jsonb,
  status text DEFAULT 'generating'::text CHECK (status = ANY (ARRAY['generating'::text, 'completed'::text, 'error'::text])),
  file_url text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  location_id uuid,
  is_consolidated boolean DEFAULT false,
  CONSTRAINT financial_reports_pkey PRIMARY KEY (id),
  CONSTRAINT financial_reports_location_id_fkey FOREIGN KEY (location_id) REFERENCES public.locations(id)
);
CREATE TABLE public.fulfillment_policies (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  delivery_enabled boolean DEFAULT true,
  delivery_zones jsonb DEFAULT '[]'::jsonb,
  default_delivery_fee numeric DEFAULT 50.00 CHECK (default_delivery_fee >= 0::numeric),
  free_delivery_threshold numeric DEFAULT 500.00 CHECK (free_delivery_threshold >= 0::numeric),
  pickup_enabled boolean DEFAULT true,
  pickup_discount_percent numeric DEFAULT 10.00 CHECK (pickup_discount_percent >= 0::numeric AND pickup_discount_percent <= 100::numeric),
  pickup_ready_time_minutes integer DEFAULT 20 CHECK (pickup_ready_time_minutes > 0),
  min_order_delivery numeric DEFAULT 200.00 CHECK (min_order_delivery >= 0::numeric),
  min_order_pickup numeric DEFAULT 100.00 CHECK (min_order_pickup >= 0::numeric),
  order_confirmation_required boolean DEFAULT true,
  auto_accept_orders boolean DEFAULT false,
  order_acceptance_timeout_minutes integer DEFAULT 10 CHECK (order_acceptance_timeout_minutes > 0),
  estimated_prep_time_minutes integer DEFAULT 30 CHECK (estimated_prep_time_minutes > 0),
  estimated_delivery_time_minutes integer DEFAULT 45 CHECK (estimated_delivery_time_minutes > 0),
  max_advance_order_days integer DEFAULT 7 CHECK (max_advance_order_days >= 0),
  auto_assign_drivers boolean DEFAULT false,
  driver_assignment_radius_km numeric DEFAULT 10.00 CHECK (driver_assignment_radius_km > 0::numeric),
  max_concurrent_deliveries_per_driver integer DEFAULT 3 CHECK (max_concurrent_deliveries_per_driver > 0),
  packaging_fee numeric DEFAULT 0.00 CHECK (packaging_fee >= 0::numeric),
  utensils_default boolean DEFAULT true,
  special_instructions_max_length integer DEFAULT 500 CHECK (special_instructions_max_length > 0),
  cancellation_allowed boolean DEFAULT true,
  cancellation_deadline_minutes integer DEFAULT 15 CHECK (cancellation_deadline_minutes >= 0),
  refund_policy_enabled boolean DEFAULT true,
  refund_processing_days integer DEFAULT 7 CHECK (refund_processing_days > 0),
  tips_enabled boolean DEFAULT true,
  suggested_tip_percentages jsonb DEFAULT '[10, 15, 20]'::jsonb,
  service_charge_enabled boolean DEFAULT false,
  service_charge_percent numeric DEFAULT 10.00 CHECK (service_charge_percent >= 0::numeric AND service_charge_percent <= 100::numeric),
  customer_contact_required boolean DEFAULT true,
  order_tracking_enabled boolean DEFAULT true,
  delivery_notifications_enabled boolean DEFAULT true,
  custom_delivery_hours jsonb DEFAULT '{}'::jsonb,
  is_system boolean DEFAULT false,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT fulfillment_policies_pkey PRIMARY KEY (id),
  CONSTRAINT fulfillment_policies_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id)
);
CREATE TABLE public.fulfillment_queue (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  order_id uuid,
  fulfillment_type text NOT NULL CHECK (fulfillment_type = ANY (ARRAY['onsite'::text, 'pickup'::text, 'delivery'::text])),
  status text NOT NULL CHECK (status = ANY (ARRAY['pending'::text, 'in_progress'::text, 'ready'::text, 'completed'::text, 'cancelled'::text])),
  assigned_to uuid,
  priority integer DEFAULT 0,
  estimated_ready_time timestamp with time zone,
  actual_ready_time timestamp with time zone,
  location_id uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  metadata jsonb DEFAULT '{}'::jsonb,
  CONSTRAINT fulfillment_queue_pkey PRIMARY KEY (id),
  CONSTRAINT fulfillment_queue_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.sales(id),
  CONSTRAINT fulfillment_queue_location_id_fkey FOREIGN KEY (location_id) REFERENCES public.locations(id)
);
CREATE TABLE public.integrations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL UNIQUE,
  description text,
  type text NOT NULL CHECK (type = ANY (ARRAY['payment'::text, 'messaging'::text, 'analytics'::text, 'delivery'::text, 'pos'::text, 'fiscal'::text])),
  status text NOT NULL DEFAULT 'inactive'::text CHECK (status = ANY (ARRAY['active'::text, 'inactive'::text, 'error'::text])),
  config jsonb NOT NULL DEFAULT '{}'::jsonb,
  last_sync timestamp with time zone,
  last_error text,
  error_count integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  created_by uuid,
  CONSTRAINT integrations_pkey PRIMARY KEY (id),
  CONSTRAINT integrations_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id)
);
CREATE TABLE public.inventory_alert_settings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  low_stock_threshold integer NOT NULL DEFAULT 10,
  critical_stock_threshold integer NOT NULL DEFAULT 5,
  abc_analysis_thresholds jsonb NOT NULL DEFAULT '{"a_threshold": 80, "b_threshold": 15, "c_threshold": 5}'::jsonb,
  auto_reorder_enabled boolean NOT NULL DEFAULT false,
  reorder_quantity_rules jsonb NOT NULL DEFAULT '{"method": "economic_order_quantity", "max_order": 100, "min_order": 10, "lead_time_days": 3, "safety_stock_days": 7, "order_point_method": "fixed", "reorder_multiplier": 1.0}'::jsonb,
  is_system boolean NOT NULL DEFAULT false,
  created_by uuid,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  out_of_stock_threshold integer NOT NULL DEFAULT 0,
  abc_analysis_enabled boolean NOT NULL DEFAULT true,
  expiry_warning_days integer NOT NULL DEFAULT 7,
  expiry_critical_days integer NOT NULL DEFAULT 3 CHECK (expiry_critical_days >= 0),
  waste_threshold_percent numeric NOT NULL DEFAULT 5.00 CHECK (waste_threshold_percent >= 0::numeric AND waste_threshold_percent <= 100::numeric),
  CONSTRAINT inventory_alert_settings_pkey PRIMARY KEY (id),
  CONSTRAINT inventory_alert_settings_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id)
);
CREATE TABLE public.inventory_transfers (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  transfer_number character varying NOT NULL UNIQUE,
  from_location_id uuid NOT NULL,
  to_location_id uuid NOT NULL,
  item_id uuid NOT NULL,
  quantity numeric NOT NULL CHECK (quantity > 0::numeric),
  unit character varying NOT NULL,
  status character varying NOT NULL DEFAULT 'pending'::character varying CHECK (status::text = ANY (ARRAY['pending'::character varying, 'approved'::character varying, 'in_transit'::character varying, 'completed'::character varying, 'cancelled'::character varying, 'rejected'::character varying]::text[])),
  requested_by character varying,
  approved_by character varying,
  completed_by character varying,
  reason text,
  notes text,
  requested_at timestamp with time zone DEFAULT now(),
  approved_at timestamp with time zone,
  completed_at timestamp with time zone,
  cancelled_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT inventory_transfers_pkey PRIMARY KEY (id),
  CONSTRAINT inventory_transfers_from_location_id_fkey FOREIGN KEY (from_location_id) REFERENCES public.locations(id),
  CONSTRAINT inventory_transfers_to_location_id_fkey FOREIGN KEY (to_location_id) REFERENCES public.locations(id),
  CONSTRAINT inventory_transfers_item_id_fkey FOREIGN KEY (item_id) REFERENCES public.materials(id)
);
CREATE TABLE public.invoices (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  invoice_number character varying NOT NULL UNIQUE,
  customer_id uuid,
  sale_id uuid,
  invoice_type text NOT NULL CHECK (invoice_type = ANY (ARRAY['A'::text, 'B'::text, 'C'::text, 'E'::text])),
  subtotal numeric NOT NULL DEFAULT 0,
  tax_amount numeric NOT NULL DEFAULT 0,
  total numeric NOT NULL DEFAULT 0,
  status text DEFAULT 'draft'::text CHECK (status = ANY (ARRAY['draft'::text, 'sent'::text, 'paid'::text, 'cancelled'::text, 'overdue'::text])),
  due_date date,
  afip_cae character varying,
  afip_cae_due_date date,
  qr_code text,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  location_id uuid,
  punto_venta integer DEFAULT 1,
  numero integer,
  tipo_comprobante character varying CHECK (tipo_comprobante::text = ANY (ARRAY['A'::character varying, 'B'::character varying, 'C'::character varying, 'E'::character varying, 'M'::character varying]::text[])),
  journal_entry_id uuid,
  CONSTRAINT invoices_pkey PRIMARY KEY (id),
  CONSTRAINT invoices_location_id_fkey FOREIGN KEY (location_id) REFERENCES public.locations(id),
  CONSTRAINT invoices_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id),
  CONSTRAINT invoices_sale_id_fkey FOREIGN KEY (sale_id) REFERENCES public.sales(id),
  CONSTRAINT invoices_journal_entry_id_fkey FOREIGN KEY (journal_entry_id) REFERENCES public.journal_entries(id)
);
CREATE TABLE public.item_modifications (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  order_item_id uuid NOT NULL,
  type text NOT NULL CHECK (type = ANY (ARRAY['addition'::text, 'substitution'::text, 'removal'::text, 'preparation_style'::text, 'extra_portion'::text, 'sauce_on_side'::text])),
  description text NOT NULL,
  price_adjustment numeric NOT NULL DEFAULT 0.00,
  ingredients_affected ARRAY DEFAULT '{}'::text[],
  preparation_notes text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT item_modifications_pkey PRIMARY KEY (id),
  CONSTRAINT item_modifications_order_item_id_fkey FOREIGN KEY (order_item_id) REFERENCES public.order_items(id)
);
CREATE TABLE public.journal_entries (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  entry_number character varying UNIQUE,
  entry_type text NOT NULL CHECK (entry_type = ANY (ARRAY['SALE'::text, 'PURCHASE'::text, 'PAYMENT'::text, 'RECEIPT'::text, 'TRANSFER'::text, 'ADJUSTMENT'::text, 'PAYROLL'::text, 'EXPENSE'::text, 'CASH_DROP'::text, 'DEPOSIT'::text, 'OPENING'::text, 'CLOSING'::text])),
  transaction_date date NOT NULL,
  posting_date date NOT NULL DEFAULT CURRENT_DATE,
  reference_id uuid,
  reference_type text,
  external_reference text,
  description text,
  notes text,
  location_id uuid,
  cash_session_id uuid,
  created_by uuid,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  is_posted boolean DEFAULT false,
  posted_at timestamp with time zone,
  CONSTRAINT journal_entries_pkey PRIMARY KEY (id),
  CONSTRAINT journal_entries_location_id_fkey FOREIGN KEY (location_id) REFERENCES public.locations(id),
  CONSTRAINT journal_entries_cash_session_id_fkey FOREIGN KEY (cash_session_id) REFERENCES public.cash_sessions(id),
  CONSTRAINT journal_entries_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id)
);
CREATE TABLE public.journal_lines (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  journal_entry_id uuid NOT NULL,
  account_id uuid NOT NULL,
  money_location_id uuid,
  amount numeric NOT NULL CHECK (amount <> 0::numeric),
  description text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT journal_lines_pkey PRIMARY KEY (id),
  CONSTRAINT journal_lines_journal_entry_id_fkey FOREIGN KEY (journal_entry_id) REFERENCES public.journal_entries(id),
  CONSTRAINT journal_lines_account_id_fkey FOREIGN KEY (account_id) REFERENCES public.chart_of_accounts(id),
  CONSTRAINT journal_lines_money_location_id_fkey FOREIGN KEY (money_location_id) REFERENCES public.money_locations(id)
);
CREATE TABLE public.locations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid,
  name character varying NOT NULL,
  code character varying NOT NULL UNIQUE,
  type character varying DEFAULT 'branch'::character varying,
  punto_venta_afip integer NOT NULL UNIQUE,
  domicilio_afip text NOT NULL,
  address_line_1 text NOT NULL,
  address_line_2 text,
  city character varying,
  state character varying,
  postal_code character varying,
  country character varying DEFAULT 'Argentina'::character varying,
  latitude numeric,
  longitude numeric,
  status character varying DEFAULT 'active'::character varying,
  opening_date date,
  closing_date date,
  phone character varying,
  email character varying,
  manager_id uuid,
  operating_hours jsonb,
  timezone character varying DEFAULT 'America/Argentina/Buenos_Aires'::character varying,
  is_main boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  created_by uuid,
  CONSTRAINT locations_pkey PRIMARY KEY (id)
);
CREATE TABLE public.maintenance_schedules (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  equipment_id text,
  equipment_name text NOT NULL,
  maintenance_type text NOT NULL CHECK (maintenance_type = ANY (ARRAY['preventive'::text, 'corrective'::text, 'inspection'::text])),
  technician_id uuid,
  technician_name text,
  scheduled_date date NOT NULL,
  scheduled_start_time time without time zone NOT NULL,
  scheduled_end_time time without time zone NOT NULL,
  estimated_cost numeric,
  notes text,
  status text DEFAULT 'scheduled'::text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT maintenance_schedules_pkey PRIMARY KEY (id),
  CONSTRAINT maintenance_schedules_technician_id_fkey FOREIGN KEY (technician_id) REFERENCES public.employees(id)
);
CREATE TABLE public.materials (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name character varying NOT NULL,
  type text NOT NULL CHECK (type = ANY (ARRAY['MEASURABLE'::text, 'COUNTABLE'::text, 'ELABORATED'::text])),
  stock numeric NOT NULL DEFAULT 0,
  unit_cost numeric DEFAULT 0,
  unit character varying NOT NULL,
  category text CHECK (category = ANY (ARRAY['weight'::text, 'volume'::text, 'length'::text])),
  precision_digits integer DEFAULT 2,
  package_size integer,
  package_unit character varying,
  package_cost numeric,
  display_mode text CHECK (display_mode = ANY (ARRAY['individual'::text, 'packaged'::text, 'both'::text])),
  recipe_id uuid,
  requires_production boolean DEFAULT false,
  auto_calculate_cost boolean DEFAULT false,
  ingredients_available boolean DEFAULT false,
  production_time integer,
  batch_size numeric,
  min_stock numeric DEFAULT 0,
  max_stock numeric,
  location character varying,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  location_id uuid,
  CONSTRAINT materials_pkey PRIMARY KEY (id),
  CONSTRAINT items_location_id_fkey FOREIGN KEY (location_id) REFERENCES public.locations(id)
);
CREATE TABLE public.member_benefits (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  tier_id uuid NOT NULL,
  benefit_type text NOT NULL CHECK (benefit_type = ANY (ARRAY['discount'::text, 'free_item'::text, 'priority_service'::text, 'early_access'::text, 'facility_access'::text])),
  benefit_value jsonb NOT NULL,
  description text,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT member_benefits_pkey PRIMARY KEY (id),
  CONSTRAINT member_benefits_tier_id_fkey FOREIGN KEY (tier_id) REFERENCES public.membership_tiers(id)
);
CREATE TABLE public.membership_tiers (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  tier_name text NOT NULL UNIQUE,
  tier_level integer NOT NULL UNIQUE,
  monthly_price numeric NOT NULL,
  yearly_price numeric,
  discount_percentage integer DEFAULT 0 CHECK (discount_percentage >= 0 AND discount_percentage <= 100),
  description text,
  features jsonb DEFAULT '[]'::jsonb,
  max_guests integer DEFAULT 0,
  personal_trainer_sessions integer DEFAULT 0,
  nutrition_consultations integer DEFAULT 0,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT membership_tiers_pkey PRIMARY KEY (id)
);
CREATE TABLE public.membership_usage (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  membership_id uuid NOT NULL,
  benefit_id uuid,
  usage_type text NOT NULL CHECK (usage_type = ANY (ARRAY['check_in'::text, 'check_out'::text, 'benefit_used'::text, 'guest_access'::text])),
  used_at timestamp with time zone DEFAULT now(),
  order_id uuid,
  facility text,
  notes text,
  CONSTRAINT membership_usage_pkey PRIMARY KEY (id),
  CONSTRAINT membership_usage_membership_id_fkey FOREIGN KEY (membership_id) REFERENCES public.memberships(id),
  CONSTRAINT membership_usage_benefit_id_fkey FOREIGN KEY (benefit_id) REFERENCES public.member_benefits(id),
  CONSTRAINT membership_usage_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.sales(id)
);
CREATE TABLE public.memberships (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  customer_id uuid NOT NULL UNIQUE,
  tier_id uuid NOT NULL,
  status text NOT NULL DEFAULT 'active'::text CHECK (status = ANY (ARRAY['active'::text, 'expired'::text, 'cancelled'::text, 'suspended'::text])),
  start_date date NOT NULL DEFAULT CURRENT_DATE,
  end_date date,
  auto_renew boolean DEFAULT true,
  payment_frequency text DEFAULT 'monthly'::text CHECK (payment_frequency = ANY (ARRAY['monthly'::text, 'quarterly'::text, 'yearly'::text])),
  registration_fee numeric DEFAULT 0,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT memberships_pkey PRIMARY KEY (id),
  CONSTRAINT memberships_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id),
  CONSTRAINT memberships_tier_id_fkey FOREIGN KEY (tier_id) REFERENCES public.membership_tiers(id)
);
CREATE TABLE public.menu_engineering_analysis (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  recipe_id uuid NOT NULL,
  analysis_date date NOT NULL DEFAULT CURRENT_DATE,
  popularity_index numeric NOT NULL DEFAULT 0.0,
  profitability_index numeric NOT NULL DEFAULT 0.0,
  menu_category text,
  recommendation text,
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT menu_engineering_analysis_pkey PRIMARY KEY (id),
  CONSTRAINT menu_engineering_analysis_recipe_id_fkey FOREIGN KEY (recipe_id) REFERENCES public.recipes(id)
);
CREATE TABLE public.menu_performance (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  product_id uuid NOT NULL,
  date date NOT NULL,
  units_sold integer NOT NULL DEFAULT 0,
  revenue numeric NOT NULL DEFAULT 0.00,
  average_rating numeric,
  rank_by_revenue smallint,
  rank_by_volume smallint,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT menu_performance_pkey PRIMARY KEY (id)
);
CREATE TABLE public.mobile_inventory_constraints (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  vehicle_id uuid NOT NULL,
  material_id uuid NOT NULL,
  max_quantity numeric NOT NULL DEFAULT 0,
  current_quantity numeric NOT NULL DEFAULT 0,
  unit text NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT mobile_inventory_constraints_pkey PRIMARY KEY (id)
);
CREATE TABLE public.mobile_routes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  route_name text NOT NULL,
  route_date date NOT NULL,
  driver_id uuid,
  vehicle_id uuid,
  start_location jsonb,
  end_location jsonb,
  waypoints ARRAY,
  status text NOT NULL CHECK (status = ANY (ARRAY['planned'::text, 'in_progress'::text, 'completed'::text, 'cancelled'::text])),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT mobile_routes_pkey PRIMARY KEY (id)
);
CREATE TABLE public.money_locations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  account_id uuid NOT NULL,
  name text NOT NULL,
  code character varying UNIQUE,
  location_type text NOT NULL CHECK (location_type = ANY (ARRAY['CASH_DRAWER'::text, 'SAFE'::text, 'BANK_ACCOUNT'::text, 'DIGITAL_WALLET'::text, 'PETTY_CASH'::text])),
  requires_session boolean DEFAULT false,
  default_float numeric,
  max_cash_limit numeric,
  responsible_user_id uuid,
  location_id uuid,
  current_balance numeric DEFAULT 0,
  is_active boolean DEFAULT true,
  description text,
  external_account_number text,
  api_credentials jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  created_by uuid,
  updated_by uuid,
  CONSTRAINT money_locations_pkey PRIMARY KEY (id),
  CONSTRAINT money_locations_account_id_fkey FOREIGN KEY (account_id) REFERENCES public.chart_of_accounts(id),
  CONSTRAINT money_locations_responsible_user_id_fkey FOREIGN KEY (responsible_user_id) REFERENCES auth.users(id),
  CONSTRAINT money_locations_location_id_fkey FOREIGN KEY (location_id) REFERENCES public.locations(id),
  CONSTRAINT money_locations_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id),
  CONSTRAINT money_locations_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES auth.users(id)
);
CREATE TABLE public.money_movements (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  journal_entry_id uuid NOT NULL,
  money_location_id uuid NOT NULL,
  cash_session_id uuid,
  movement_type text NOT NULL CHECK (movement_type = ANY (ARRAY['IN'::text, 'OUT'::text, 'TRANSFER_IN'::text, 'TRANSFER_OUT'::text])),
  amount numeric NOT NULL,
  running_balance numeric,
  description text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  created_by uuid,
  CONSTRAINT money_movements_pkey PRIMARY KEY (id),
  CONSTRAINT money_movements_journal_entry_id_fkey FOREIGN KEY (journal_entry_id) REFERENCES public.journal_entries(id),
  CONSTRAINT money_movements_money_location_id_fkey FOREIGN KEY (money_location_id) REFERENCES public.money_locations(id),
  CONSTRAINT money_movements_cash_session_id_fkey FOREIGN KEY (cash_session_id) REFERENCES public.cash_sessions(id),
  CONSTRAINT money_movements_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id)
);
CREATE TABLE public.operation_locks (
  id text NOT NULL,
  operation_type text NOT NULL,
  status text NOT NULL DEFAULT 'processing'::text CHECK (status = ANY (ARRAY['processing'::text, 'completed'::text, 'failed'::text])),
  request_params jsonb NOT NULL,
  result jsonb,
  error_message text,
  user_id uuid,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  completed_at timestamp with time zone,
  expires_at timestamp with time zone NOT NULL DEFAULT (now() + '24:00:00'::interval),
  ip_address inet,
  user_agent text,
  CONSTRAINT operation_locks_pkey PRIMARY KEY (id),
  CONSTRAINT operation_locks_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.operational_shifts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  business_id uuid NOT NULL,
  opened_by uuid NOT NULL,
  opened_at timestamp with time zone NOT NULL DEFAULT now(),
  closed_by uuid,
  closed_at timestamp with time zone,
  status text NOT NULL DEFAULT 'active'::text CHECK (status = ANY (ARRAY['active'::text, 'closed'::text])),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  total_sales numeric DEFAULT 0.00,
  labor_cost numeric DEFAULT 0.00,
  active_staff_count integer DEFAULT 0,
  open_notes text,
  close_notes text,
  location_id uuid,
  cash_total numeric DEFAULT 0,
  card_total numeric DEFAULT 0,
  transfer_total numeric DEFAULT 0,
  qr_total numeric DEFAULT 0,
  other_total numeric DEFAULT 0,
  CONSTRAINT operational_shifts_pkey PRIMARY KEY (id),
  CONSTRAINT operational_shifts_location_id_fkey FOREIGN KEY (location_id) REFERENCES public.locations(id)
);
CREATE TABLE public.order_items (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  order_id uuid NOT NULL,
  product_id uuid NOT NULL,
  quantity smallint NOT NULL CHECK (quantity > 0),
  unit_price numeric NOT NULL CHECK (unit_price >= 0::numeric),
  line_total numeric NOT NULL DEFAULT 0.00,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'in_progress'::text, 'ready'::text, 'served'::text, 'cancelled'::text])),
  station_assigned text CHECK (station_assigned = ANY (ARRAY['cold_station'::text, 'hot_station'::text, 'grill'::text, 'fryer'::text, 'dessert'::text, 'bar'::text, 'prep'::text])),
  preparation_time_estimate interval DEFAULT '00:15:00'::interval,
  actual_prep_time interval,
  special_instructions text,
  allergy_warnings ARRAY DEFAULT '{}'::text[],
  modifications ARRAY DEFAULT '{}'::text[],
  temperature_preference text CHECK (temperature_preference = ANY (ARRAY['rare'::text, 'medium_rare'::text, 'medium'::text, 'medium_well'::text, 'well_done'::text, 'extra_hot'::text, 'warm'::text, 'cold'::text])),
  spice_level smallint CHECK (spice_level >= 0 AND spice_level <= 10),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  started_prep_at timestamp with time zone,
  ready_at timestamp with time zone,
  served_at timestamp with time zone,
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT order_items_pkey PRIMARY KEY (id),
  CONSTRAINT order_items_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id)
);
CREATE TABLE public.orders (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  order_number character varying NOT NULL UNIQUE,
  sale_id uuid,
  table_id uuid,
  customer_id uuid,
  party_id uuid,
  status text NOT NULL DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'confirmed'::text, 'preparing'::text, 'ready'::text, 'served'::text, 'completed'::text, 'cancelled'::text, 'refunded'::text])),
  order_type text NOT NULL CHECK (order_type = ANY (ARRAY['dine_in'::text, 'takeout'::text, 'delivery'::text, 'pickup'::text, 'catering'::text, 'drive_thru'::text])),
  fulfillment_type text NOT NULL CHECK (fulfillment_type = ANY (ARRAY['dine_in'::text, 'takeout'::text, 'delivery'::text, 'pickup'::text, 'curbside'::text])),
  priority_level text DEFAULT 'normal'::text CHECK (priority_level = ANY (ARRAY['low'::text, 'normal'::text, 'high'::text, 'rush'::text, 'vip'::text, 'urgent'::text])),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  estimated_ready_time timestamp with time zone,
  actual_ready_time timestamp with time zone,
  pickup_time timestamp with time zone,
  completed_at timestamp with time zone,
  preparation_time interval,
  kitchen_notes text,
  special_instructions ARRAY DEFAULT '{}'::text[],
  allergy_warnings ARRAY DEFAULT '{}'::text[],
  dietary_requirements ARRAY DEFAULT '{}'::text[],
  subtotal numeric NOT NULL DEFAULT 0.00,
  taxes numeric NOT NULL DEFAULT 0.00,
  tips numeric NOT NULL DEFAULT 0.00,
  discounts numeric NOT NULL DEFAULT 0.00,
  total numeric NOT NULL DEFAULT 0.00,
  customer_rating smallint CHECK (customer_rating >= 1 AND customer_rating <= 10),
  feedback text,
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT orders_pkey PRIMARY KEY (id)
);
CREATE TABLE public.organization_features (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  organization_id uuid NOT NULL,
  feature_id text NOT NULL,
  enabled boolean DEFAULT true,
  config jsonb DEFAULT '{}'::jsonb,
  activated_at timestamp with time zone DEFAULT now(),
  activated_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT organization_features_pkey PRIMARY KEY (id),
  CONSTRAINT organization_features_organization_id_fkey FOREIGN KEY (organization_id) REFERENCES public.organizations(id)
);
CREATE TABLE public.organizations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  slug text NOT NULL UNIQUE,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  settings jsonb DEFAULT '{}'::jsonb,
  CONSTRAINT organizations_pkey PRIMARY KEY (id)
);
CREATE TABLE public.parties (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  table_id uuid NOT NULL,
  customer_id uuid,
  size integer NOT NULL,
  status text DEFAULT 'waiting'::text CHECK (status = ANY (ARRAY['waiting'::text, 'seated'::text, 'dining'::text, 'paying'::text, 'completed'::text])),
  seated_at timestamp with time zone,
  completed_at timestamp with time zone,
  estimated_duration integer,
  actual_duration integer,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  customer_name text,
  total_spent numeric DEFAULT 0.00,
  CONSTRAINT parties_pkey PRIMARY KEY (id),
  CONSTRAINT parties_table_id_fkey FOREIGN KEY (table_id) REFERENCES public.tables(id),
  CONSTRAINT parties_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id)
);
CREATE TABLE public.payment_gateways (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  type text NOT NULL CHECK (type = ANY (ARRAY['card'::text, 'digital_wallet'::text, 'bank_transfer'::text, 'qr_payment'::text, 'cash'::text, 'crypto'::text, 'bnpl'::text])),
  name text NOT NULL,
  provider text,
  is_active boolean NOT NULL DEFAULT true,
  is_online boolean NOT NULL DEFAULT false,
  supports_refunds boolean NOT NULL DEFAULT false,
  supports_recurring boolean NOT NULL DEFAULT false,
  config jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT payment_gateways_pkey PRIMARY KEY (id)
);
CREATE TABLE public.payment_methods (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  sale_id uuid NOT NULL,
  order_id uuid,
  type text NOT NULL CHECK (type = ANY (ARRAY['cash'::text, 'credit_card'::text, 'debit_card'::text, 'nfc_card'::text, 'mobile_wallet'::text, 'qr_code'::text, 'digital_wallet'::text, 'crypto'::text, 'bnpl'::text, 'gift_card'::text, 'store_credit'::text])),
  amount numeric NOT NULL CHECK (amount > 0::numeric),
  provider text CHECK (provider = ANY (ARRAY['visa'::text, 'mastercard'::text, 'amex'::text, 'discover'::text, 'paypal'::text, 'apple_pay'::text, 'google_pay'::text, 'venmo'::text, 'square'::text, 'stripe'::text])),
  transaction_id text,
  authorization_code text,
  reference_number text,
  batch_id text,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'processing'::text, 'authorized'::text, 'captured'::text, 'completed'::text, 'failed'::text, 'cancelled'::text, 'refunded'::text, 'disputed'::text])),
  processed_at timestamp with time zone,
  is_contactless boolean NOT NULL DEFAULT false,
  processing_time interval,
  tip_amount numeric NOT NULL DEFAULT 0.00,
  tip_percentage numeric,
  receipt_method text CHECK (receipt_method = ANY (ARRAY['email'::text, 'sms'::text, 'app_notification'::text, 'printed'::text, 'none'::text])),
  customer_signature text,
  terminal_id text,
  last_four_digits character varying,
  card_brand text,
  is_emv boolean DEFAULT false,
  cvv_verified boolean DEFAULT false,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT payment_methods_pkey PRIMARY KEY (id),
  CONSTRAINT payment_methods_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id)
);
CREATE TABLE public.payment_methods_config (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  gateway_id uuid,
  name text NOT NULL,
  code text NOT NULL UNIQUE,
  display_name text NOT NULL,
  description text,
  icon text,
  requires_gateway boolean NOT NULL DEFAULT false,
  is_active boolean NOT NULL DEFAULT true,
  sort_order integer DEFAULT 0,
  config jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT payment_methods_config_pkey PRIMARY KEY (id),
  CONSTRAINT payment_methods_config_gateway_id_fkey FOREIGN KEY (gateway_id) REFERENCES public.payment_gateways(id)
);
CREATE TABLE public.payments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  invoice_id uuid NOT NULL,
  payment_method_id uuid,
  amount numeric NOT NULL CHECK (amount > 0::numeric),
  currency text NOT NULL DEFAULT 'ARS'::text CHECK (currency = ANY (ARRAY['ARS'::text, 'USD'::text, 'EUR'::text])),
  status text NOT NULL DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'completed'::text, 'failed'::text, 'refunded'::text])),
  transaction_id text,
  provider text,
  failure_reason text,
  retry_count integer NOT NULL DEFAULT 0,
  processed_at timestamp with time zone,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  created_by uuid,
  CONSTRAINT payments_pkey PRIMARY KEY (id),
  CONSTRAINT payments_invoice_id_fkey FOREIGN KEY (invoice_id) REFERENCES public.invoices(id),
  CONSTRAINT payments_payment_method_id_fkey FOREIGN KEY (payment_method_id) REFERENCES public.payment_methods(id),
  CONSTRAINT payments_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id)
);
CREATE TABLE public.payroll_periods (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  employee_id uuid NOT NULL,
  period_start date NOT NULL,
  period_end date NOT NULL,
  regular_hours numeric DEFAULT 0.00,
  overtime_hours numeric DEFAULT 0.00,
  total_hours numeric DEFAULT 0.00,
  regular_pay numeric DEFAULT 0.00,
  overtime_pay numeric DEFAULT 0.00,
  total_pay numeric DEFAULT 0.00,
  status text NOT NULL DEFAULT 'draft'::text CHECK (status = ANY (ARRAY['draft'::text, 'calculated'::text, 'approved'::text, 'paid'::text])),
  deductions jsonb DEFAULT '[]'::jsonb,
  bonuses jsonb DEFAULT '[]'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  created_by uuid,
  updated_by uuid,
  CONSTRAINT payroll_periods_pkey PRIMARY KEY (id),
  CONSTRAINT payroll_periods_employee_id_fkey FOREIGN KEY (employee_id) REFERENCES public.employees(id),
  CONSTRAINT payroll_periods_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id),
  CONSTRAINT payroll_periods_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES auth.users(id)
);
CREATE TABLE public.percepciones_retenciones (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  invoice_id uuid NOT NULL,
  type text NOT NULL CHECK (type = ANY (ARRAY['percepcion'::text, 'retencion'::text])),
  tax_type character varying NOT NULL,
  percentage numeric NOT NULL,
  amount numeric NOT NULL,
  jurisdiction character varying,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT percepciones_retenciones_pkey PRIMARY KEY (id),
  CONSTRAINT percepciones_retenciones_invoice_id_fkey FOREIGN KEY (invoice_id) REFERENCES public.invoices(id)
);
CREATE TABLE public.pickup_time_slots (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  day_of_week integer NOT NULL CHECK (day_of_week >= 0 AND day_of_week <= 6),
  start_time time without time zone NOT NULL,
  end_time time without time zone NOT NULL,
  max_orders integer NOT NULL DEFAULT 10,
  current_orders integer NOT NULL DEFAULT 0,
  is_active boolean NOT NULL DEFAULT true,
  notes text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone,
  deleted_at timestamp with time zone,
  CONSTRAINT pickup_time_slots_pkey PRIMARY KEY (id)
);
CREATE TABLE public.pos_async_dead_letter_queue (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  original_operation_id uuid,
  entity_type USER-DEFINED NOT NULL,
  entity_id uuid NOT NULL,
  operation_type USER-DEFINED NOT NULL,
  final_error_message text NOT NULL,
  failed_at timestamp with time zone NOT NULL DEFAULT now(),
  total_retry_count smallint NOT NULL,
  original_payload jsonb,
  CONSTRAINT pos_async_dead_letter_queue_pkey PRIMARY KEY (id),
  CONSTRAINT pos_async_dead_letter_queue_original_operation_id_fkey FOREIGN KEY (original_operation_id) REFERENCES public.pos_async_operations(id)
);
CREATE TABLE public.pos_async_operations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  entity_type USER-DEFINED NOT NULL,
  entity_id uuid NOT NULL,
  operation_type USER-DEFINED NOT NULL,
  priority smallint NOT NULL DEFAULT 5 CHECK (priority >= 1 AND priority <= 10),
  retry_count smallint NOT NULL DEFAULT 0 CHECK (retry_count >= 0),
  max_retries smallint NOT NULL DEFAULT 3 CHECK (max_retries > 0),
  status USER-DEFINED NOT NULL DEFAULT 'pending'::pos_async_status,
  error_message text,
  error_code text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  started_at timestamp with time zone,
  completed_at timestamp with time zone,
  next_retry_at timestamp with time zone,
  operation_payload jsonb DEFAULT '{}'::jsonb,
  CONSTRAINT pos_async_operations_pkey PRIMARY KEY (id)
);
CREATE TABLE public.pricing_tiers (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  pricing_config_id uuid,
  min_quantity numeric,
  max_quantity numeric,
  min_value numeric,
  max_value numeric,
  discount_percentage numeric NOT NULL CHECK (discount_percentage >= 0::numeric AND discount_percentage <= 100::numeric),
  fixed_price numeric,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT pricing_tiers_pkey PRIMARY KEY (id),
  CONSTRAINT pricing_tiers_pricing_config_id_fkey FOREIGN KEY (pricing_config_id) REFERENCES public.tiered_pricings(id)
);
CREATE TABLE public.product_asset_configs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  asset_id uuid NOT NULL,
  depreciation_config jsonb DEFAULT '{}'::jsonb,
  security_deposit_config jsonb DEFAULT '{}'::jsonb,
  inspection_config jsonb DEFAULT '{}'::jsonb,
  insurance_config jsonb DEFAULT '{}'::jsonb,
  maintenance_config jsonb DEFAULT '{}'::jsonb,
  availability_config jsonb DEFAULT '{}'::jsonb,
  gps_config jsonb DEFAULT '{}'::jsonb,
  usage_restrictions jsonb DEFAULT '{}'::jsonb,
  accessories jsonb DEFAULT '[]'::jsonb,
  checklist_templates jsonb DEFAULT '[]'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  created_by uuid,
  updated_by uuid,
  CONSTRAINT product_asset_configs_pkey PRIMARY KEY (id),
  CONSTRAINT product_asset_configs_asset_id_fkey FOREIGN KEY (asset_id) REFERENCES public.assets(id)
);
CREATE TABLE public.product_catalog_settings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  product_categories jsonb DEFAULT '[]'::jsonb,
  menu_categories jsonb DEFAULT '[]'::jsonb,
  pricing_strategy character varying DEFAULT 'markup'::character varying CHECK (pricing_strategy::text = ANY (ARRAY['markup'::character varying, 'competitive'::character varying, 'value_based'::character varying]::text[])),
  default_markup_percentage numeric DEFAULT 200.00 CHECK (default_markup_percentage >= 0::numeric AND default_markup_percentage <= 1000::numeric),
  recipe_costing_method character varying DEFAULT 'average'::character varying CHECK (recipe_costing_method::text = ANY (ARRAY['average'::character varying, 'fifo'::character varying, 'lifo'::character varying, 'standard'::character varying]::text[])),
  check_stock boolean DEFAULT true,
  allow_backorders boolean DEFAULT false,
  auto_disable_on_zero_stock boolean DEFAULT true,
  minimum_notice_minutes integer DEFAULT 0 CHECK (minimum_notice_minutes >= 0),
  modifiers_configuration jsonb DEFAULT '[]'::jsonb,
  portion_sizes jsonb DEFAULT '[]'::jsonb,
  is_system boolean DEFAULT false,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT product_catalog_settings_pkey PRIMARY KEY (id),
  CONSTRAINT product_catalog_settings_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id)
);
CREATE TABLE public.product_components (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  product_id uuid NOT NULL,
  item_id uuid NOT NULL,
  quantity_required numeric NOT NULL,
  unit character varying,
  is_optional boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  material_name character varying,
  unit_cost numeric,
  total_cost numeric,
  notes text,
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT product_components_pkey PRIMARY KEY (id),
  CONSTRAINT product_components_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(id),
  CONSTRAINT product_components_item_id_fkey FOREIGN KEY (item_id) REFERENCES public.materials(id)
);
CREATE TABLE public.product_digital_deliveries (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  delivery_type character varying NOT NULL CHECK (delivery_type::text = ANY (ARRAY['download'::character varying, 'streaming'::character varying, 'access'::character varying, 'redirect'::character varying, 'hybrid'::character varying]::text[])),
  download_config jsonb DEFAULT '{}'::jsonb,
  streaming_config jsonb DEFAULT '{}'::jsonb,
  access_config jsonb DEFAULT '{}'::jsonb,
  redirect_config jsonb DEFAULT '{}'::jsonb,
  hybrid_config jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  created_by uuid,
  updated_by uuid,
  CONSTRAINT product_digital_deliveries_pkey PRIMARY KEY (id)
);
CREATE TABLE public.product_recurring_configs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  billing_cycle character varying NOT NULL CHECK (billing_cycle::text = ANY (ARRAY['weekly'::character varying, 'monthly'::character varying, 'quarterly'::character varying, 'yearly'::character varying]::text[])),
  trial_enabled boolean DEFAULT false,
  trial_duration_days integer CHECK (trial_duration_days >= 0),
  trial_price numeric DEFAULT 0 CHECK (trial_price >= 0::numeric),
  billing_day integer CHECK (billing_day >= 1 AND billing_day <= 31),
  prorate_first_payment boolean DEFAULT false,
  auto_renewal boolean DEFAULT true,
  auto_renewal_notice_days integer DEFAULT 7 CHECK (auto_renewal_notice_days >= 0),
  cancellation_policy character varying CHECK (cancellation_policy::text = ANY (ARRAY['anytime'::character varying, 'end_of_cycle'::character varying, 'notice_required'::character varying]::text[])),
  cancellation_notice_days integer CHECK (cancellation_notice_days >= 0),
  access_type character varying NOT NULL CHECK (access_type::text = ANY (ARRAY['unlimited'::character varying, 'credits_based'::character varying, 'tier_based'::character varying]::text[])),
  monthly_credits integer CHECK (monthly_credits > 0),
  tier_benefits ARRAY,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  created_by uuid,
  updated_by uuid,
  CONSTRAINT product_recurring_configs_pkey PRIMARY KEY (id)
);
CREATE TABLE public.product_rental_terms (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  security_deposit jsonb DEFAULT '{}'::jsonb,
  late_return_policy jsonb DEFAULT '{}'::jsonb,
  damage_policy jsonb DEFAULT '{}'::jsonb,
  insurance_options jsonb DEFAULT '[]'::jsonb,
  usage_restrictions jsonb DEFAULT '{}'::jsonb,
  cancellation_policy jsonb DEFAULT '{}'::jsonb,
  maintenance_cleaning jsonb DEFAULT '{}'::jsonb,
  additional_terms text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  created_by uuid,
  updated_by uuid,
  CONSTRAINT product_rental_terms_pkey PRIMARY KEY (id)
);
CREATE TABLE public.product_staff_allocations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  product_id uuid NOT NULL,
  role_id uuid NOT NULL,
  role_name character varying,
  count integer NOT NULL DEFAULT 1 CHECK (count > 0),
  duration_minutes integer NOT NULL CHECK (duration_minutes > 0),
  hourly_rate numeric CHECK (hourly_rate >= 0::numeric),
  total_hours numeric DEFAULT ((duration_minutes)::numeric / 60.0),
  total_cost numeric,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT product_staff_allocations_pkey PRIMARY KEY (id),
  CONSTRAINT product_staff_allocations_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(id)
);
CREATE TABLE public.products (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name character varying NOT NULL,
  description text,
  price numeric NOT NULL DEFAULT 0,
  category character varying,
  is_active boolean DEFAULT true,
  requires_ingredients boolean DEFAULT false,
  preparation_time integer,
  calories integer,
  allergens ARRAY,
  image_url text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  duration_minutes integer,
  requires_specific_professional boolean DEFAULT false,
  cancellation_policy character varying DEFAULT 'flexible'::character varying CHECK (cancellation_policy::text = ANY (ARRAY['flexible'::character varying, '24h_notice'::character varying, '48h_notice'::character varying, 'strict'::character varying]::text[])),
  available_for_online_booking boolean DEFAULT true,
  type character varying DEFAULT 'ELABORATED'::character varying CHECK (type::text = ANY (ARRAY['ELABORATED'::character varying, 'SERVICE'::character varying, 'RETAIL'::character varying, 'EVENT'::character varying, 'DIGITAL'::character varying, 'TRAINING'::character varying]::text[])),
  available_online boolean DEFAULT false,
  online_price numeric,
  online_stock integer,
  online_visibility character varying DEFAULT 'visible'::character varying,
  seo_title character varying,
  seo_description text,
  seo_keywords ARRAY,
  config jsonb DEFAULT '{}'::jsonb,
  optional_components jsonb DEFAULT '[]'::jsonb,
  pricing jsonb DEFAULT '{}'::jsonb,
  availability jsonb DEFAULT '{}'::jsonb,
  product_type character varying NOT NULL CHECK (product_type::text = ANY (ARRAY['physical_product'::character varying, 'service'::character varying, 'rental'::character varying, 'digital'::character varying, 'membership'::character varying]::text[])),
  has_materials boolean DEFAULT false,
  has_staff_requirements boolean DEFAULT false,
  asset_config_id uuid,
  rental_terms_id uuid,
  digital_delivery_id uuid,
  recurring_config_id uuid,
  active boolean NOT NULL DEFAULT true,
  created_by uuid,
  updated_by uuid,
  is_published boolean NOT NULL DEFAULT false,
  recipe_id uuid,
  CONSTRAINT products_pkey PRIMARY KEY (id),
  CONSTRAINT fk_products_asset_config FOREIGN KEY (asset_config_id) REFERENCES public.product_asset_configs(id),
  CONSTRAINT fk_products_rental_terms FOREIGN KEY (rental_terms_id) REFERENCES public.product_rental_terms(id),
  CONSTRAINT fk_products_digital_delivery FOREIGN KEY (digital_delivery_id) REFERENCES public.product_digital_deliveries(id),
  CONSTRAINT fk_products_recurring_config FOREIGN KEY (recurring_config_id) REFERENCES public.product_recurring_configs(id),
  CONSTRAINT fk_products_recipe FOREIGN KEY (recipe_id) REFERENCES public.recipes(id)
);
CREATE TABLE public.professional_availability (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  staff_id uuid NOT NULL,
  location_id uuid,
  day_of_week integer NOT NULL CHECK (day_of_week >= 0 AND day_of_week <= 6),
  start_time time without time zone NOT NULL,
  end_time time without time zone NOT NULL,
  is_active boolean DEFAULT true,
  break_start_time time without time zone,
  break_end_time time without time zone,
  override_buffer_minutes integer,
  override_slot_duration integer,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT professional_availability_pkey PRIMARY KEY (id),
  CONSTRAINT professional_availability_staff_id_fkey FOREIGN KEY (staff_id) REFERENCES public.employees(id),
  CONSTRAINT professional_availability_location_id_fkey FOREIGN KEY (location_id) REFERENCES public.locations(id)
);
CREATE TABLE public.provider_availability (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  provider_id uuid NOT NULL,
  day_of_week integer NOT NULL CHECK (day_of_week >= 0 AND day_of_week <= 6),
  start_time time without time zone NOT NULL,
  end_time time without time zone NOT NULL,
  is_available boolean DEFAULT true,
  break_times jsonb DEFAULT '[]'::jsonb,
  valid_from date,
  valid_until date,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT provider_availability_pkey PRIMARY KEY (id),
  CONSTRAINT provider_availability_provider_id_fkey FOREIGN KEY (provider_id) REFERENCES auth.users(id)
);
CREATE TABLE public.qr_order_items (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  qr_order_id uuid NOT NULL,
  product_id uuid NOT NULL,
  quantity smallint NOT NULL CHECK (quantity > 0),
  unit_price numeric NOT NULL CHECK (unit_price >= 0::numeric),
  line_total numeric NOT NULL DEFAULT 0.00,
  special_instructions text,
  modifications ARRAY DEFAULT '{}'::text[],
  size_option text,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'confirmed'::text, 'cancelled'::text])),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT qr_order_items_pkey PRIMARY KEY (id),
  CONSTRAINT qr_order_items_qr_order_id_fkey FOREIGN KEY (qr_order_id) REFERENCES public.qr_orders(id)
);
CREATE TABLE public.qr_orders (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  table_id uuid NOT NULL,
  qr_code text NOT NULL UNIQUE,
  session_token text NOT NULL UNIQUE,
  status text DEFAULT 'active'::text CHECK (status = ANY (ARRAY['active'::text, 'expired'::text, 'completed'::text, 'cancelled'::text])),
  customer_name text,
  customer_phone character varying,
  customer_email character varying,
  party_size smallint CHECK (party_size >= 1 AND party_size <= 20),
  special_requests text,
  dietary_restrictions ARRAY DEFAULT '{}'::text[],
  allergy_warnings ARRAY DEFAULT '{}'::text[],
  service_preference text CHECK (service_preference = ANY (ARRAY['standard'::text, 'quick'::text, 'leisurely'::text, 'family_friendly'::text])),
  subtotal numeric NOT NULL DEFAULT 0.00,
  estimated_total numeric NOT NULL DEFAULT 0.00,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  expires_at timestamp with time zone NOT NULL,
  submitted_at timestamp with time zone,
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT qr_orders_pkey PRIMARY KEY (id)
);
CREATE TABLE public.recipe_ingredients (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  recipe_id uuid,
  item_id uuid,
  quantity integer NOT NULL,
  conversion_factor numeric DEFAULT 1.0,
  yield_percentage numeric DEFAULT 100.0,
  waste_percentage numeric DEFAULT 0.0,
  unit_cost_override numeric,
  CONSTRAINT recipe_ingredients_pkey PRIMARY KEY (id),
  CONSTRAINT recipe_ingredients_recipe_id_fkey FOREIGN KEY (recipe_id) REFERENCES public.recipes(id)
);
CREATE TABLE public.recipe_performance (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  recipe_id uuid NOT NULL,
  date date NOT NULL DEFAULT CURRENT_DATE,
  times_produced integer NOT NULL DEFAULT 0,
  actual_cost numeric NOT NULL DEFAULT 0.00,
  times_sold integer DEFAULT 0,
  revenue_generated numeric DEFAULT 0.00,
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT recipe_performance_pkey PRIMARY KEY (id),
  CONSTRAINT recipe_performance_recipe_id_fkey FOREIGN KEY (recipe_id) REFERENCES public.recipes(id)
);
CREATE TABLE public.recipes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  output_item_id uuid,
  output_quantity integer NOT NULL,
  created_at timestamp without time zone DEFAULT now(),
  description text,
  difficulty_level text,
  recipe_category text,
  kitchen_station text,
  base_cost numeric DEFAULT 0.00,
  yield_percentage numeric DEFAULT 100.0,
  updated_at timestamp without time zone DEFAULT now(),
  preparation_time integer,
  menu_category text,
  popularity_score numeric DEFAULT 0.0,
  profitability_score numeric DEFAULT 0.0,
  labor_cost numeric DEFAULT 0.00,
  overhead_cost numeric DEFAULT 0.00,
  instructions text,
  serving_size integer DEFAULT 1,
  allergens ARRAY DEFAULT '{}'::text[],
  dietary_tags ARRAY DEFAULT '{}'::text[],
  image_url text,
  waste_percentage numeric DEFAULT 5.0,
  packaging_cost numeric DEFAULT 0.00,
  nutritional_info jsonb DEFAULT '{}'::jsonb,
  temperature_requirements jsonb DEFAULT '{}'::jsonb,
  shelf_life interval DEFAULT '24:00:00'::interval,
  quality_checks ARRAY DEFAULT '{}'::text[],
  entity_type character varying NOT NULL CHECK (entity_type::text = ANY (ARRAY['material'::character varying, 'product'::character varying, 'kit'::character varying, 'service'::character varying]::text[])),
  execution_mode character varying NOT NULL CHECK (execution_mode::text = ANY (ARRAY['immediate'::character varying, 'on_demand'::character varying]::text[])),
  CONSTRAINT recipes_pkey PRIMARY KEY (id)
);
CREATE TABLE public.reminder_settings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  business_profile_id uuid UNIQUE,
  sms_enabled boolean DEFAULT false,
  sms_provider text CHECK ((sms_provider = ANY (ARRAY['twilio'::text, 'messagebird'::text, 'vonage'::text, 'manual'::text])) OR sms_provider IS NULL),
  sms_api_key_encrypted text,
  sms_from_number text,
  email_enabled boolean DEFAULT false,
  email_provider text CHECK ((email_provider = ANY (ARRAY['sendgrid'::text, 'mailgun'::text, 'resend'::text, 'smtp'::text])) OR email_provider IS NULL),
  email_api_key_encrypted text,
  email_from_address text,
  reminder_hours_before integer DEFAULT 24 CHECK (reminder_hours_before >= 0),
  confirmation_hours_before integer DEFAULT 48 CHECK (confirmation_hours_before >= 0),
  sms_reminder_template text DEFAULT 'Recordatorio: Tienes una cita el {{date}} a las {{time}} con {{provider}}. {{business_name}}'::text,
  email_reminder_template text DEFAULT 'Hola {{customer_name}},\n\nEste es un recordatorio de tu cita:\n\nFecha: {{date}}\nHora: {{time}}\nProveedor: {{provider}}\nServicio: {{service}}\n\nGracias,\n{{business_name}}'::text,
  sms_confirmation_template text DEFAULT 'Cita confirmada para {{date}} a las {{time}}. {{business_name}}'::text,
  email_confirmation_template text DEFAULT 'Tu cita ha sido confirmada.\n\nDetalles:\nFecha: {{date}}\nHora: {{time}}\nProveedor: {{provider}}\nServicio: {{service}}'::text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT reminder_settings_pkey PRIMARY KEY (id),
  CONSTRAINT reminder_settings_business_profile_id_fkey FOREIGN KEY (business_profile_id) REFERENCES public.business_profiles(id)
);
CREATE TABLE public.rental_items (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  item_name text NOT NULL,
  item_type text NOT NULL CHECK (item_type = ANY (ARRAY['equipment'::text, 'space'::text, 'vehicle'::text, 'tools'::text])),
  description text,
  hourly_rate numeric,
  daily_rate numeric,
  weekly_rate numeric,
  monthly_rate numeric,
  deposit_amount numeric DEFAULT 0,
  quantity_available integer DEFAULT 1 CHECK (quantity_available >= 0),
  max_rental_duration_days integer,
  min_rental_duration_hours integer DEFAULT 1,
  is_active boolean DEFAULT true,
  condition text DEFAULT 'good'::text CHECK (condition = ANY (ARRAY['excellent'::text, 'good'::text, 'fair'::text, 'needs_maintenance'::text, 'out_of_service'::text])),
  images jsonb DEFAULT '[]'::jsonb,
  specifications jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT rental_items_pkey PRIMARY KEY (id)
);
CREATE TABLE public.rental_reservations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  item_id uuid NOT NULL,
  customer_id uuid NOT NULL,
  status text NOT NULL DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'confirmed'::text, 'active'::text, 'completed'::text, 'cancelled'::text])),
  start_datetime timestamp with time zone NOT NULL,
  end_datetime timestamp with time zone NOT NULL,
  actual_pickup_datetime timestamp with time zone,
  actual_return_datetime timestamp with time zone,
  rental_rate numeric NOT NULL CHECK (rental_rate > 0::numeric),
  rate_type text NOT NULL DEFAULT 'daily'::text CHECK (rate_type = ANY (ARRAY['hourly'::text, 'daily'::text, 'weekly'::text, 'monthly'::text])),
  deposit_paid numeric DEFAULT 0,
  total_amount numeric NOT NULL,
  late_fees numeric DEFAULT 0,
  damage_fees numeric DEFAULT 0,
  payment_status text DEFAULT 'unpaid'::text CHECK (payment_status = ANY (ARRAY['unpaid'::text, 'partial'::text, 'paid'::text, 'refunded'::text, 'overdue'::text])),
  payment_method text,
  checkout_condition text DEFAULT 'good'::text CHECK (checkout_condition = ANY (ARRAY['excellent'::text, 'good'::text, 'fair'::text, 'damaged'::text])),
  return_condition text CHECK (return_condition = ANY (ARRAY['excellent'::text, 'good'::text, 'fair'::text, 'damaged'::text])),
  damage_report text,
  notes text,
  internal_notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  created_by uuid,
  CONSTRAINT rental_reservations_pkey PRIMARY KEY (id),
  CONSTRAINT rental_reservations_item_id_fkey FOREIGN KEY (item_id) REFERENCES public.rental_items(id),
  CONSTRAINT rental_reservations_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id)
);
CREATE TABLE public.reservations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  customer_id uuid,
  table_id uuid,
  party_size integer NOT NULL,
  reservation_date date NOT NULL,
  reservation_time time without time zone NOT NULL,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'confirmed'::text, 'seated'::text, 'completed'::text, 'cancelled'::text, 'no_show'::text])),
  special_requests text,
  contact_phone character varying,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT reservations_pkey PRIMARY KEY (id),
  CONSTRAINT reservations_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id),
  CONSTRAINT reservations_table_id_fkey FOREIGN KEY (table_id) REFERENCES public.tables(id)
);
CREATE TABLE public.rls_policy_backups (
  id integer NOT NULL DEFAULT nextval('rls_policy_backups_id_seq'::regclass),
  policy_name text,
  table_schema text,
  table_name text,
  command text,
  roles text,
  definition text,
  check_clause text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT rls_policy_backups_pkey PRIMARY KEY (id)
);
CREATE TABLE public.role_review_schedule (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  role text NOT NULL,
  assigned_date timestamp with time zone NOT NULL,
  last_review_date timestamp with time zone,
  next_review_date timestamp with time zone NOT NULL,
  review_frequency_days integer DEFAULT 90,
  reviewer_user_id uuid,
  review_status text DEFAULT 'pending'::text,
  review_notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT role_review_schedule_pkey PRIMARY KEY (id),
  CONSTRAINT role_review_schedule_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT role_review_schedule_reviewer_user_id_fkey FOREIGN KEY (reviewer_user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.sale_items (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  sale_id uuid NOT NULL,
  product_id uuid,
  item_id uuid,
  quantity numeric NOT NULL,
  unit_price numeric NOT NULL,
  total_price numeric NOT NULL,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT sale_items_pkey PRIMARY KEY (id),
  CONSTRAINT sale_items_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(id),
  CONSTRAINT sale_items_sale_id_fkey FOREIGN KEY (sale_id) REFERENCES public.sales(id),
  CONSTRAINT sale_materials_item_id_fkey FOREIGN KEY (item_id) REFERENCES public.materials(id)
);
CREATE TABLE public.sale_payments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  sale_id uuid NOT NULL,
  journal_entry_id uuid NOT NULL,
  amount numeric NOT NULL,
  payment_type text NOT NULL,
  metadata jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  transaction_type USER-DEFINED NOT NULL DEFAULT 'PAYMENT'::payment_transaction_type,
  parent_payment_id uuid,
  payment_method_id uuid,
  cash_session_id uuid,
  shift_id uuid,
  status USER-DEFINED NOT NULL DEFAULT 'INITIATED'::payment_status,
  status_history jsonb DEFAULT '[]'::jsonb,
  initiated_at timestamp with time zone NOT NULL DEFAULT now(),
  authorized_at timestamp with time zone,
  captured_at timestamp with time zone,
  submitted_for_settlement_at timestamp with time zone,
  settled_at timestamp with time zone,
  voided_at timestamp with time zone,
  refunded_at timestamp with time zone,
  idempotency_key uuid DEFAULT gen_random_uuid() UNIQUE,
  updated_at timestamp with time zone DEFAULT now(),
  created_by uuid,
  updated_by uuid,
  currency text DEFAULT 'ARS'::text,
  CONSTRAINT sale_payments_pkey PRIMARY KEY (id),
  CONSTRAINT sale_payments_parent_payment_id_fkey FOREIGN KEY (parent_payment_id) REFERENCES public.sale_payments(id),
  CONSTRAINT sale_payments_payment_method_id_fkey FOREIGN KEY (payment_method_id) REFERENCES public.payment_methods_config(id),
  CONSTRAINT sale_payments_cash_session_id_fkey FOREIGN KEY (cash_session_id) REFERENCES public.cash_sessions(id),
  CONSTRAINT sale_payments_shift_id_fkey FOREIGN KEY (shift_id) REFERENCES public.operational_shifts(id),
  CONSTRAINT sale_payments_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id),
  CONSTRAINT sale_payments_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES auth.users(id),
  CONSTRAINT sale_payments_sale_id_fkey FOREIGN KEY (sale_id) REFERENCES public.sales(id),
  CONSTRAINT sale_payments_journal_entry_id_fkey FOREIGN KEY (journal_entry_id) REFERENCES public.journal_entries(id)
);
CREATE TABLE public.sales (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  customer_id uuid,
  table_id uuid,
  total numeric NOT NULL DEFAULT 0,
  subtotal numeric NOT NULL DEFAULT 0,
  tax numeric NOT NULL DEFAULT 0,
  discount numeric DEFAULT 0,
  payment_method text DEFAULT 'cash'::text CHECK (payment_method = ANY (ARRAY['cash'::text, 'card'::text, 'transfer'::text, 'other'::text])),
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'completed'::text, 'cancelled'::text])),
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  location_id uuid,
  order_type character varying DEFAULT 'POS'::character varying CHECK (order_type::text = ANY (ARRAY['POS'::character varying, 'ONLINE'::character varying, 'APPOINTMENT'::character varying, 'B2B_QUOTE'::character varying, 'B2B_ORDER'::character varying]::text[])),
  order_status character varying DEFAULT 'PENDING'::character varying CHECK (order_status::text = ANY (ARRAY['PENDING'::character varying, 'CONFIRMED'::character varying, 'IN_PROGRESS'::character varying, 'COMPLETED'::character varying, 'CANCELLED'::character varying, 'REFUNDED'::character varying]::text[])),
  payment_status character varying DEFAULT 'PENDING'::character varying CHECK (payment_status::text = ANY (ARRAY['PENDING'::character varying, 'PAID'::character varying, 'PARTIALLY_PAID'::character varying, 'REFUNDED'::character varying, 'FAILED'::character varying]::text[])),
  scheduled_time timestamp with time zone,
  assigned_staff_id uuid,
  service_id uuid,
  cancellation_reason text,
  cancelled_at timestamp with time zone,
  reminder_sent_24h timestamp with time zone,
  reminder_sent_2h timestamp with time zone,
  journal_entry_id uuid,
  CONSTRAINT sales_pkey PRIMARY KEY (id),
  CONSTRAINT sales_location_id_fkey FOREIGN KEY (location_id) REFERENCES public.locations(id),
  CONSTRAINT sales_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id),
  CONSTRAINT sales_assigned_staff_id_fkey FOREIGN KEY (assigned_staff_id) REFERENCES public.employees(id),
  CONSTRAINT sales_service_id_fkey FOREIGN KEY (service_id) REFERENCES public.products(id),
  CONSTRAINT sales_journal_entry_id_fkey FOREIGN KEY (journal_entry_id) REFERENCES public.journal_entries(id)
);
CREATE TABLE public.schedules (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name character varying NOT NULL,
  start_date date NOT NULL,
  end_date date NOT NULL,
  status text DEFAULT 'draft'::text CHECK (status = ANY (ARRAY['draft'::text, 'published'::text, 'archived'::text])),
  created_by uuid,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT schedules_pkey PRIMARY KEY (id)
);
CREATE TABLE public.security_audit_log (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  user_email text,
  user_role text,
  action_type text NOT NULL,
  resource_table text,
  resource_id uuid,
  policy_name text,
  access_level text,
  ip_address inet,
  user_agent text,
  session_id text,
  success boolean DEFAULT true,
  error_message text,
  additional_context jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT security_audit_log_pkey PRIMARY KEY (id),
  CONSTRAINT security_audit_log_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.service_events (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  party_id uuid NOT NULL,
  table_id uuid,
  event_type text NOT NULL CHECK (event_type = ANY (ARRAY['order_taken'::text, 'food_served'::text, 'drinks_served'::text, 'check_requested'::text, 'payment_processed'::text, 'table_cleaned'::text])),
  server_id uuid,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT service_events_pkey PRIMARY KEY (id),
  CONSTRAINT service_events_party_id_fkey FOREIGN KEY (party_id) REFERENCES public.parties(id),
  CONSTRAINT service_events_table_id_fkey FOREIGN KEY (table_id) REFERENCES public.tables(id)
);
CREATE TABLE public.service_packages (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  package_name text NOT NULL,
  description text,
  service_ids ARRAY NOT NULL,
  total_sessions integer NOT NULL CHECK (total_sessions > 0),
  package_price numeric NOT NULL CHECK (package_price >= 0::numeric),
  per_session_price numeric NOT NULL CHECK (per_session_price >= 0::numeric),
  validity_days integer CHECK (validity_days IS NULL OR validity_days > 0),
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT service_packages_pkey PRIMARY KEY (id)
);
CREATE TABLE public.shift_payments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  shift_id uuid NOT NULL,
  sale_id uuid,
  employee_id uuid,
  payment_method text NOT NULL CHECK (payment_method = ANY (ARRAY['CARD'::text, 'TRANSFER'::text, 'QR'::text, 'OTHER'::text])),
  amount numeric NOT NULL CHECK (amount > 0::numeric),
  payment_date timestamp with time zone NOT NULL DEFAULT now(),
  reference text,
  notes text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT shift_payments_pkey PRIMARY KEY (id),
  CONSTRAINT shift_payments_shift_id_fkey FOREIGN KEY (shift_id) REFERENCES public.operational_shifts(id),
  CONSTRAINT shift_payments_sale_id_fkey FOREIGN KEY (sale_id) REFERENCES public.sales(id),
  CONSTRAINT shift_payments_employee_id_fkey FOREIGN KEY (employee_id) REFERENCES public.employees(id)
);
CREATE TABLE public.shift_schedules (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  employee_id uuid NOT NULL,
  date date NOT NULL,
  start_time time without time zone NOT NULL,
  end_time time without time zone NOT NULL,
  position character varying,
  break_duration integer DEFAULT 30,
  hourly_rate numeric,
  total_hours numeric DEFAULT ((EXTRACT(epoch FROM (end_time - start_time)) / (3600)::numeric) - ((COALESCE(break_duration, 0))::numeric / 60.0)),
  total_pay numeric DEFAULT (((EXTRACT(epoch FROM (end_time - start_time)) / (3600)::numeric) - ((COALESCE(break_duration, 0))::numeric / 60.0)) * COALESCE(hourly_rate, (0)::numeric)),
  schedule_id uuid,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  status USER-DEFINED,
  CONSTRAINT shift_schedules_pkey PRIMARY KEY (id),
  CONSTRAINT shift_schedules_employee_id_fkey FOREIGN KEY (employee_id) REFERENCES public.employees(id),
  CONSTRAINT shift_schedules_schedule_id_fkey FOREIGN KEY (schedule_id) REFERENCES public.schedules(id)
);
CREATE TABLE public.shift_templates (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name character varying NOT NULL,
  start_time time without time zone NOT NULL,
  end_time time without time zone NOT NULL,
  days_of_week ARRAY NOT NULL,
  role character varying,
  min_employees integer DEFAULT 1,
  max_employees integer DEFAULT 1,
  hourly_rate numeric,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT shift_templates_pkey PRIMARY KEY (id)
);
CREATE TABLE public.shifts (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  employee_id uuid NOT NULL,
  start_time timestamp with time zone NOT NULL,
  end_time timestamp with time zone NOT NULL,
  role character varying,
  status text DEFAULT 'scheduled'::text CHECK (status = ANY (ARRAY['scheduled'::text, 'confirmed'::text, 'in_progress'::text, 'completed'::text, 'cancelled'::text])),
  break_duration integer DEFAULT 0,
  hourly_rate numeric,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  location_id uuid,
  date text,
  position text,
  CONSTRAINT shifts_pkey PRIMARY KEY (id),
  CONSTRAINT shifts_employee_id_fkey FOREIGN KEY (employee_id) REFERENCES public.employees(id),
  CONSTRAINT shifts_location_id_fkey FOREIGN KEY (location_id) REFERENCES public.locations(id)
);
CREATE TABLE public.split_bills (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  sale_id uuid NOT NULL,
  order_id uuid,
  total_amount numeric NOT NULL CHECK (total_amount > 0::numeric),
  split_type text NOT NULL CHECK (split_type = ANY (ARRAY['even'::text, 'item_based'::text, 'custom'::text, 'percentage'::text])),
  number_of_splits smallint NOT NULL CHECK (number_of_splits >= 2 AND number_of_splits <= 20),
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'in_progress'::text, 'completed'::text, 'cancelled'::text])),
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  completed_at timestamp with time zone,
  CONSTRAINT split_bills_pkey PRIMARY KEY (id),
  CONSTRAINT split_bills_order_id_fkey FOREIGN KEY (order_id) REFERENCES public.orders(id)
);
CREATE TABLE public.staff_policies (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  departments jsonb NOT NULL DEFAULT '[]'::jsonb,
  positions jsonb NOT NULL DEFAULT '[]'::jsonb,
  default_hourly_rates jsonb DEFAULT '{}'::jsonb,
  overtime_enabled boolean DEFAULT true,
  overtime_threshold_hours numeric DEFAULT 40.00,
  overtime_multiplier numeric DEFAULT 1.50 CHECK (overtime_multiplier >= 1.00 AND overtime_multiplier <= 3.00),
  overtime_calculation_period character varying DEFAULT 'weekly'::character varying CHECK (overtime_calculation_period::text = ANY (ARRAY['daily'::character varying, 'weekly'::character varying, 'biweekly'::character varying, 'monthly'::character varying]::text[])),
  break_duration_minutes integer DEFAULT 30 CHECK (break_duration_minutes >= 0 AND break_duration_minutes <= 120),
  break_frequency_hours numeric DEFAULT 4.0 CHECK (break_frequency_hours > 0::numeric AND break_frequency_hours <= 12::numeric),
  unpaid_break_threshold integer DEFAULT 6 CHECK (unpaid_break_threshold >= 0 AND unpaid_break_threshold <= 12),
  shift_swap_advance_notice_hours integer DEFAULT 24 CHECK (shift_swap_advance_notice_hours >= 0),
  shift_swap_approval_required boolean DEFAULT true,
  shift_swap_limit_per_month integer DEFAULT 4 CHECK (shift_swap_limit_per_month >= 0),
  attendance_grace_period_minutes integer DEFAULT 5 CHECK (attendance_grace_period_minutes >= 0 AND attendance_grace_period_minutes <= 30),
  late_threshold_minutes integer DEFAULT 15 CHECK (late_threshold_minutes >= 0 AND late_threshold_minutes <= 60),
  max_late_arrivals_per_month integer DEFAULT 3 CHECK (max_late_arrivals_per_month >= 0),
  max_unexcused_absences_per_month integer DEFAULT 2 CHECK (max_unexcused_absences_per_month >= 0),
  time_clock_rounding_minutes integer DEFAULT 15 CHECK (time_clock_rounding_minutes = ANY (ARRAY[0, 5, 10, 15])),
  performance_review_frequency_days integer DEFAULT 90 CHECK (performance_review_frequency_days > 0),
  training_requirements jsonb DEFAULT '[]'::jsonb,
  certification_tracking_enabled boolean DEFAULT false,
  mandatory_certifications jsonb DEFAULT '[]'::jsonb,
  onboarding_checklist_required boolean DEFAULT true,
  onboarding_duration_days integer DEFAULT 30 CHECK (onboarding_duration_days > 0),
  termination_notice_period_days integer DEFAULT 15 CHECK (termination_notice_period_days >= 0),
  exit_interview_required boolean DEFAULT true,
  is_system boolean DEFAULT false,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT staff_policies_pkey PRIMARY KEY (id),
  CONSTRAINT staff_policies_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id)
);
CREATE TABLE public.staffing_requirements (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  position character varying NOT NULL,
  day_of_week integer NOT NULL CHECK (day_of_week >= 0 AND day_of_week <= 6),
  time_slot time without time zone NOT NULL,
  min_staff integer NOT NULL DEFAULT 1,
  max_staff integer NOT NULL DEFAULT 1,
  optimal_staff integer NOT NULL DEFAULT 1,
  priority_level text DEFAULT 'medium'::text CHECK (priority_level = ANY (ARRAY['low'::text, 'medium'::text, 'high'::text, 'critical'::text])),
  cost_center character varying,
  department character varying,
  skills_required ARRAY DEFAULT '{}'::text[],
  is_active boolean DEFAULT true,
  effective_date date DEFAULT CURRENT_DATE,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT staffing_requirements_pkey PRIMARY KEY (id)
);
CREATE TABLE public.stock_entries (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  item_id uuid NOT NULL,
  supplier_id uuid,
  quantity numeric NOT NULL,
  unit_cost numeric DEFAULT 0,
  entry_type text DEFAULT 'purchase'::text CHECK (entry_type = ANY (ARRAY['purchase'::text, 'production'::text, 'adjustment'::text, 'return'::text])),
  batch_number character varying,
  expiry_date date,
  purchase_date date DEFAULT CURRENT_DATE,
  invoice_number text,
  delivery_date date,
  quality_rating smallint CHECK (quality_rating >= 1 AND quality_rating <= 5),
  note text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  location_id uuid,
  metadata jsonb DEFAULT '{}'::jsonb,
  CONSTRAINT stock_entries_pkey PRIMARY KEY (id),
  CONSTRAINT stock_entries_item_id_fkey FOREIGN KEY (item_id) REFERENCES public.materials(id),
  CONSTRAINT stock_entries_supplier_id_fkey FOREIGN KEY (supplier_id) REFERENCES public.suppliers(id),
  CONSTRAINT stock_entries_location_id_fkey FOREIGN KEY (location_id) REFERENCES public.locations(id)
);
CREATE TABLE public.subscriptions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  customer_id uuid NOT NULL,
  subscription_name text NOT NULL,
  description text,
  internal_notes text,
  billing_type text NOT NULL CHECK (billing_type = ANY (ARRAY['monthly'::text, 'quarterly'::text, 'annual'::text, 'custom'::text])),
  amount numeric NOT NULL CHECK (amount > 0::numeric),
  currency text NOT NULL DEFAULT 'ARS'::text CHECK (currency = ANY (ARRAY['ARS'::text, 'USD'::text, 'EUR'::text])),
  tax_included boolean NOT NULL DEFAULT true,
  custom_interval integer,
  custom_interval_type text CHECK (custom_interval_type = ANY (ARRAY['days'::text, 'weeks'::text, 'months'::text])),
  start_date date NOT NULL,
  end_date date,
  billing_cycles integer,
  status text NOT NULL DEFAULT 'active'::text CHECK (status = ANY (ARRAY['active'::text, 'suspended'::text, 'cancelled'::text, 'trial'::text])),
  auto_invoice boolean NOT NULL DEFAULT true,
  auto_collect boolean NOT NULL DEFAULT false,
  retry_failed_payments boolean NOT NULL DEFAULT true,
  max_retries integer NOT NULL DEFAULT 3 CHECK (max_retries >= 0 AND max_retries <= 5),
  payment_terms text NOT NULL DEFAULT 'immediate'::text CHECK (payment_terms = ANY (ARRAY['immediate'::text, 'net15'::text, 'net30'::text, 'net45'::text])),
  reminder_days ARRAY NOT NULL DEFAULT ARRAY[7, 3, 1],
  prorate boolean NOT NULL DEFAULT false,
  allow_usage_charges boolean NOT NULL DEFAULT false,
  suspend_on_failure boolean NOT NULL DEFAULT false,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  created_by uuid,
  updated_by uuid,
  CONSTRAINT subscriptions_pkey PRIMARY KEY (id),
  CONSTRAINT subscriptions_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES auth.users(id),
  CONSTRAINT subscriptions_customer_id_fkey FOREIGN KEY (customer_id) REFERENCES public.customers(id),
  CONSTRAINT subscriptions_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id)
);
CREATE TABLE public.supplier_order_items (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  supplier_order_id uuid NOT NULL,
  material_id uuid NOT NULL,
  quantity numeric NOT NULL CHECK (quantity > 0::numeric),
  unit_cost numeric NOT NULL CHECK (unit_cost >= 0::numeric),
  total_cost numeric DEFAULT (quantity * unit_cost),
  received_quantity numeric DEFAULT 0 CHECK (received_quantity >= 0::numeric),
  notes text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT supplier_order_items_pkey PRIMARY KEY (id),
  CONSTRAINT supplier_order_items_supplier_order_id_fkey FOREIGN KEY (supplier_order_id) REFERENCES public.supplier_orders(id),
  CONSTRAINT supplier_order_materials_material_id_fkey FOREIGN KEY (material_id) REFERENCES public.materials(id)
);
CREATE TABLE public.supplier_orders (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  po_number character varying NOT NULL UNIQUE,
  supplier_id uuid NOT NULL,
  status character varying NOT NULL DEFAULT 'draft'::character varying CHECK (status::text = ANY (ARRAY['draft'::character varying, 'pending'::character varying, 'approved'::character varying, 'received'::character varying, 'cancelled'::character varying]::text[])),
  total_amount numeric DEFAULT 0 CHECK (total_amount >= 0::numeric),
  expected_delivery_date date,
  actual_delivery_date date,
  notes text,
  internal_notes text,
  created_by uuid,
  approved_by uuid,
  received_by uuid,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  approved_at timestamp with time zone,
  received_at timestamp with time zone,
  cancelled_at timestamp with time zone,
  journal_entry_id uuid,
  CONSTRAINT supplier_orders_pkey PRIMARY KEY (id),
  CONSTRAINT supplier_orders_supplier_id_fkey FOREIGN KEY (supplier_id) REFERENCES public.suppliers(id),
  CONSTRAINT supplier_orders_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id),
  CONSTRAINT supplier_orders_approved_by_fkey FOREIGN KEY (approved_by) REFERENCES auth.users(id),
  CONSTRAINT supplier_orders_received_by_fkey FOREIGN KEY (received_by) REFERENCES auth.users(id),
  CONSTRAINT supplier_orders_journal_entry_id_fkey FOREIGN KEY (journal_entry_id) REFERENCES public.journal_entries(id)
);
CREATE TABLE public.suppliers (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL CHECK (TRIM(BOTH FROM name) <> ''::text),
  contact_person text,
  email text CHECK (email IS NULL OR email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$'::text),
  phone text,
  address text,
  tax_id text,
  payment_terms text DEFAULT '30 dÃ­as'::text,
  rating numeric CHECK (rating >= 1::numeric AND rating <= 5::numeric),
  notes text,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT suppliers_pkey PRIMARY KEY (id)
);
CREATE TABLE public.system_settings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  theme text NOT NULL DEFAULT 'auto'::text,
  language text NOT NULL DEFAULT 'es'::text,
  timezone text NOT NULL DEFAULT 'America/Argentina/Buenos_Aires'::text,
  date_format text NOT NULL DEFAULT 'DD/MM/YYYY'::text,
  time_format text NOT NULL DEFAULT '24h'::text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  updated_by uuid,
  CONSTRAINT system_settings_pkey PRIMARY KEY (id),
  CONSTRAINT system_settings_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES auth.users(id)
);
CREATE TABLE public.tables (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  number integer NOT NULL UNIQUE,
  name character varying,
  capacity integer NOT NULL DEFAULT 4,
  section character varying,
  status text DEFAULT 'available'::text CHECK (status = ANY (ARRAY['available'::text, 'occupied'::text, 'reserved'::text, 'cleaning'::text, 'ready_for_bill'::text, 'maintenance'::text])),
  location_x numeric,
  location_y numeric,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  is_active boolean DEFAULT true,
  priority text DEFAULT 'normal'::text CHECK (priority = ANY (ARRAY['normal'::text, 'vip'::text, 'urgent'::text, 'attention_needed'::text])),
  color_code text DEFAULT 'gray'::text CHECK (color_code = ANY (ARRAY['green'::text, 'yellow'::text, 'orange'::text, 'red'::text, 'blue'::text, 'gray'::text])),
  turn_count integer DEFAULT 0,
  daily_revenue numeric DEFAULT 0.00,
  CONSTRAINT tables_pkey PRIMARY KEY (id)
);
CREATE TABLE public.tax_periods (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  location_id uuid,
  periodo text NOT NULL,
  tipo text NOT NULL CHECK (tipo = ANY (ARRAY['iva_ventas'::text, 'iva_compras'::text, 'ingresos_brutos'::text, 'ganancias'::text])),
  ventas_netas numeric,
  iva_debito_fiscal numeric,
  compras_netas numeric,
  iva_credito_fiscal numeric,
  saldo_a_favor numeric,
  saldo_a_pagar numeric,
  presentado boolean DEFAULT false,
  fecha_presentacion timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT tax_periods_pkey PRIMARY KEY (id),
  CONSTRAINT tax_periods_location_id_fkey FOREIGN KEY (location_id) REFERENCES public.locations(id)
);
CREATE TABLE public.tax_reports (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  report_type text NOT NULL CHECK (report_type = ANY (ARRAY['iva'::text, 'ganancias'::text, 'ingresos_brutos'::text])),
  period_year integer NOT NULL,
  period_month integer CHECK (period_month >= 1 AND period_month <= 12),
  status text DEFAULT 'draft'::text CHECK (status = ANY (ARRAY['draft'::text, 'generated'::text, 'submitted'::text])),
  file_path text,
  generated_at timestamp with time zone,
  submitted_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  location_id uuid,
  is_consolidated boolean DEFAULT false,
  CONSTRAINT tax_reports_pkey PRIMARY KEY (id),
  CONSTRAINT tax_reports_location_id_fkey FOREIGN KEY (location_id) REFERENCES public.locations(id)
);
CREATE TABLE public.tiered_pricings (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL,
  description text,
  type text NOT NULL CHECK (type = ANY (ARRAY['volume'::text, 'value'::text, 'annual'::text])),
  is_active boolean DEFAULT true,
  applicable_products ARRAY,
  applicable_customers ARRAY,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT tiered_pricings_pkey PRIMARY KEY (id)
);
CREATE TABLE public.time_entries (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  employee_id uuid NOT NULL,
  schedule_id uuid,
  timestamp timestamp with time zone NOT NULL DEFAULT now(),
  location jsonb,
  notes text,
  is_offline boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT now(),
  created_by uuid,
  entry_type USER-DEFINED,
  sync_status USER-DEFINED,
  CONSTRAINT time_entries_pkey PRIMARY KEY (id),
  CONSTRAINT time_entries_employee_id_fkey FOREIGN KEY (employee_id) REFERENCES public.employees(id),
  CONSTRAINT time_entries_schedule_id_fkey FOREIGN KEY (schedule_id) REFERENCES public.shift_schedules(id),
  CONSTRAINT time_entries_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id)
);
CREATE TABLE public.time_off_requests (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  employee_id uuid NOT NULL,
  start_date date NOT NULL,
  end_date date NOT NULL,
  request_type text NOT NULL CHECK (request_type = ANY (ARRAY['vacation'::text, 'sick'::text, 'personal'::text, 'emergency'::text])),
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'approved'::text, 'rejected'::text])),
  reason text,
  approved_by uuid,
  approved_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT time_off_requests_pkey PRIMARY KEY (id),
  CONSTRAINT time_off_requests_employee_id_fkey FOREIGN KEY (employee_id) REFERENCES public.employees(id)
);
CREATE TABLE public.user_achievement_progress (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  achievement_id character varying NOT NULL,
  current_value integer DEFAULT 0,
  target_value integer NOT NULL,
  progress_percentage integer DEFAULT 
CASE
    WHEN (target_value > 0) THEN LEAST(100, ((current_value * 100) / target_value))
    ELSE 0
END,
  metadata jsonb,
  last_updated timestamp with time zone DEFAULT now(),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_achievement_progress_pkey PRIMARY KEY (id),
  CONSTRAINT user_achievement_progress_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT user_achievement_progress_achievement_id_fkey FOREIGN KEY (achievement_id) REFERENCES public.achievement_definitions(id)
);
CREATE TABLE public.user_achievements (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  achievement_id character varying NOT NULL,
  unlocked_at timestamp with time zone DEFAULT now(),
  progress_data jsonb,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_achievements_pkey PRIMARY KEY (id),
  CONSTRAINT user_achievements_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT user_achievements_achievement_id_fkey FOREIGN KEY (achievement_id) REFERENCES public.achievement_definitions(id)
);
CREATE TABLE public.user_preferences (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  preferences jsonb NOT NULL DEFAULT '{}'::jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_preferences_pkey PRIMARY KEY (id),
  CONSTRAINT user_preferences_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.user_roles (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL UNIQUE,
  description text,
  permissions jsonb NOT NULL DEFAULT '[]'::jsonb,
  priority integer NOT NULL DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  created_by uuid,
  CONSTRAINT user_roles_pkey PRIMARY KEY (id),
  CONSTRAINT user_roles_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id)
);
CREATE TABLE public.users_roles (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  role USER-DEFINED NOT NULL DEFAULT 'CLIENTE'::user_role,
  assigned_by uuid,
  assigned_at timestamp with time zone DEFAULT now(),
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT users_roles_pkey PRIMARY KEY (id),
  CONSTRAINT users_roles_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT users_roles_assigned_by_fkey FOREIGN KEY (assigned_by) REFERENCES auth.users(id)
);
CREATE TABLE public.walk_in_queue (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  customer_name text NOT NULL,
  customer_phone text,
  party_size integer DEFAULT 1 CHECK (party_size > 0),
  requested_service text,
  requested_provider_id uuid,
  queue_position integer CHECK (queue_position > 0),
  status text NOT NULL DEFAULT 'waiting'::text CHECK (status = ANY (ARRAY['waiting'::text, 'notified'::text, 'seated'::text, 'cancelled'::text])),
  check_in_time timestamp with time zone DEFAULT now(),
  estimated_wait_minutes integer CHECK (estimated_wait_minutes >= 0),
  notified_at timestamp with time zone,
  seated_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT walk_in_queue_pkey PRIMARY KEY (id),
  CONSTRAINT walk_in_queue_requested_provider_id_fkey FOREIGN KEY (requested_provider_id) REFERENCES auth.users(id)
);
CREATE TABLE public.webhook_events (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  provider text NOT NULL,
  event_type text NOT NULL,
  payload jsonb NOT NULL,
  status text NOT NULL DEFAULT 'pending'::text,
  attempts integer NOT NULL DEFAULT 0,
  sale_payment_id uuid,
  external_id text,
  processed_at timestamp with time zone,
  error_message text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  created_by uuid,
  updated_by uuid,
  CONSTRAINT webhook_events_pkey PRIMARY KEY (id),
  CONSTRAINT webhook_events_sale_payment_id_fkey FOREIGN KEY (sale_payment_id) REFERENCES public.sale_payments(id)
);