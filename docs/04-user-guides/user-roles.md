# üë• Sistema de Roles y Permisos - G-Admin Mini

> **√öltima actualizaci√≥n**: 2025-09-08  
> **Autor**: Consolidaci√≥n de USER_ROLES_DESIGN.md + USER_ROLES_WITH_CUSTOMERS.md  
> **Estado**: Documento unificado

## üéØ Visi√≥n General

Sistema de control de acceso basado en **5 roles** dise√±ado para el sistema de gesti√≥n restaurantera G-Admin Mini, proporcionando permisos granulares desde clientes hasta administradores del sistema.

## üèóÔ∏è Estructura de Roles

### 1. üõçÔ∏è **CLIENTE** ‚≠ê 
**Rol para usuarios finales que compran productos**

#### Permisos de Acceso:
- ‚úÖ **Customer Portal**: Portal personal con estad√≠sticas de pedidos
- ‚úÖ **Customer Menu**: Ver men√∫ y productos disponibles  
- ‚úÖ **My Orders**: Crear pedidos y ver historial completo
- ‚úÖ **Products**: Solo lectura para navegaci√≥n y selecci√≥n
- ‚úÖ **Profile Settings**: Configuraci√≥n b√°sica de perfil personal
- ‚úÖ **Payment Methods**: Gesti√≥n de m√©todos de pago personales
- ‚úÖ **Loyalty Program**: Acceso a programas de fidelizaci√≥n

#### Restricciones:
- ‚ùå **Operations**: Sin acceso a operaciones internas
- ‚ùå **Sales Management**: Sin acceso directo (solo portal de cliente)
- ‚ùå **Materials**: Sin acceso al inventario
- ‚ùå **Staff**: Sin acceso a gesti√≥n de personal
- ‚ùå **Scheduling**: Sin acceso a horarios
- ‚ùå **Fiscal**: Sin acceso fiscal
- ‚ùå **System Admin**: Sin acceso administrativo

---

### 2. üë®‚Äçüç≥ **OPERADOR**
**Acceso m√°s b√°sico - Personal de cocina y servicio**

#### Permisos de Acceso:
- ‚úÖ **Operations**: Ver/editar √≥rdenes, actualizar estados de cocina
- ‚úÖ **Sales Basic**: Crear/modificar ventas, gesti√≥n de mesas b√°sica
- ‚úÖ **Order Management**: Procesar y actualizar estado de pedidos
- ‚úÖ **Kitchen Display**: Panel de cocina y preparaci√≥n
- ‚úÖ **Basic POS**: Funciones b√°sicas de punto de venta
- ‚úÖ **Customer Service**: Atenci√≥n b√°sica al cliente

#### Restricciones:
- ‚ùå **Materials**: Solo lectura (inventario b√°sico)
- ‚ùå **Products**: Solo lectura (no puede modificar men√∫)
- ‚ùå **Staff**: Sin acceso a gesti√≥n de personal
- ‚ùå **Scheduling**: Ver solo su propio horario
- ‚ùå **Fiscal**: Sin acceso a reportes fiscales
- ‚ùå **Settings**: Sin acceso a configuraciones
- ‚ùå **Reports**: Sin acceso a reportes avanzados

---

### 3. üë©‚Äçüíº **SUPERVISOR**
**Gesti√≥n operativa diaria - Supervisores de turno**

#### Permisos de Acceso:
- ‚úÖ **Operations Full**: Control total de cocina y servicio
- ‚úÖ **Sales Management**: Gesti√≥n completa de ventas y reportes diarios
- ‚úÖ **Materials Basic**: Gesti√≥n b√°sica de inventario, alertas de stock
- ‚úÖ **Products Management**: Crear/editar productos, gesti√≥n de men√∫
- ‚úÖ **Staff Basic**: Ver performance del equipo, gesti√≥n b√°sica
- ‚úÖ **Scheduling Team**: Gesti√≥n de horarios del equipo
- ‚úÖ **Customer Management**: Gesti√≥n b√°sica de clientes
- ‚úÖ **Daily Reports**: Reportes operativos del d√≠a
- ‚úÖ **POS Advanced**: Funciones avanzadas de punto de venta

#### Restricciones:
- ‚ùå **Fiscal Full**: Solo lectura de reportes fiscales
- ‚ùå **Settings Advanced**: Solo configuraciones b√°sicas
- ‚ùå **Staff Hiring**: No puede contratar/despedir personal
- ‚ùå **System Config**: Sin acceso a configuraciones del sistema

---

### 4. üè¢ **ADMINISTRADOR**
**Gesti√≥n completa del negocio - Gerentes**

#### Permisos de Acceso:
- ‚úÖ **Operations Analytics**: Control total + analytics avanzados
- ‚úÖ **Sales Analytics**: Analytics completos, configuraci√≥n de ventas
- ‚úÖ **Materials Full**: Gesti√≥n completa de inventario + proveedores
- ‚úÖ **Products Full**: Gesti√≥n completa + an√°lisis de costos
- ‚úÖ **Staff Full**: Gesti√≥n completa de personal + reportes
- ‚úÖ **Scheduling Full**: Gesti√≥n completa de horarios + analytics
- ‚úÖ **Fiscal Management**: Gesti√≥n fiscal completa
- ‚úÖ **Business Settings**: Configuraciones del negocio
- ‚úÖ **Customer Analytics**: An√°lisis completo de clientes
- ‚úÖ **Financial Reports**: Reportes financieros avanzados
- ‚úÖ **Supplier Management**: Gesti√≥n completa de proveedores

#### Restricciones:
- ‚ùå **System Admin**: Sin acceso a configuraciones del sistema
- ‚ùå **User Management**: Sin acceso a gesti√≥n de usuarios del sistema
- ‚ùå **Database Access**: Sin acceso directo a base de datos

---

### 5. üëë **SUPER ADMIN**
**Control total del sistema - Propietarios/Desarrollo**

#### Permisos de Acceso:
- ‚úÖ **All Administrator Functions**: Todas las funciones de ADMINISTRADOR
- ‚úÖ **System Settings**: Configuraciones del sistema y base de datos
- ‚úÖ **User Management**: Crear/editar usuarios y roles
- ‚úÖ **System Analytics**: M√©tricas del sistema completo
- ‚úÖ **Backup/Restore**: Gesti√≥n de respaldos
- ‚úÖ **Security Config**: Configuraciones de seguridad
- ‚úÖ **Database Management**: Acceso y gesti√≥n de base de datos
- ‚úÖ **Feature Flags**: Control de caracter√≠sticas del sistema
- ‚úÖ **API Management**: Gesti√≥n de APIs y endpoints
- ‚úÖ **Audit Logs**: Acceso completo a logs de auditor√≠a

#### Sin Restricciones:
- ‚úÖ **Full System Access**: Acceso total al sistema

## üîß Implementaci√≥n T√©cnica

### Database Schema

```sql
-- Tabla de usuarios
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    role user_role NOT NULL DEFAULT 'operador',
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Enum de roles
CREATE TYPE user_role AS ENUM (
    'cliente',
    'operador', 
    'supervisor',
    'administrador',
    'super_admin'
);

-- Tabla de permisos espec√≠ficos
CREATE TABLE user_permissions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES users(id),
    module VARCHAR(50) NOT NULL,
    permission VARCHAR(50) NOT NULL,
    granted BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW()
);
```

### TypeScript Types

```typescript
export type UserRole = 
  | 'cliente'
  | 'operador' 
  | 'supervisor'
  | 'administrador'
  | 'super_admin';

export interface User {
  id: string;
  email: string;
  role: UserRole;
  isActive: boolean;
  profile?: UserProfile;
  permissions?: Permission[];
  createdAt: string;
  updatedAt: string;
}

export interface Permission {
  module: string;
  action: string;
  granted: boolean;
}

export interface UserProfile {
  firstName: string;
  lastName: string;
  phone?: string;
  address?: string;
  avatar?: string;
  preferences: UserPreferences;
}
```

### Permission System

```typescript
// Sistema de permisos basado en roles
export const ROLE_PERMISSIONS: Record<UserRole, Permission[]> = {
  cliente: [
    { module: 'customer-portal', action: 'read', granted: true },
    { module: 'customer-portal', action: 'write', granted: true },
    { module: 'products', action: 'read', granted: true },
    { module: 'orders', action: 'create', granted: true },
    { module: 'orders', action: 'read_own', granted: true },
    { module: 'profile', action: 'write', granted: true }
  ],
  
  operador: [
    { module: 'operations', action: 'read', granted: true },
    { module: 'operations', action: 'write', granted: true },
    { module: 'sales', action: 'read', granted: true },
    { module: 'sales', action: 'write', granted: true },
    { module: 'materials', action: 'read', granted: true },
    { module: 'products', action: 'read', granted: true },
    { module: 'scheduling', action: 'read_own', granted: true }
  ],
  
  supervisor: [
    // ... incluye todos los permisos de operador +
    { module: 'materials', action: 'write', granted: true },
    { module: 'products', action: 'write', granted: true },
    { module: 'staff', action: 'read', granted: true },
    { module: 'staff', action: 'write_basic', granted: true },
    { module: 'scheduling', action: 'write', granted: true },
    { module: 'reports', action: 'read_daily', granted: true }
  ],
  
  administrador: [
    // ... incluye todos los permisos de supervisor +
    { module: 'staff', action: 'write_full', granted: true },
    { module: 'fiscal', action: 'read', granted: true },
    { module: 'fiscal', action: 'write', granted: true },
    { module: 'settings', action: 'write_business', granted: true },
    { module: 'analytics', action: 'read', granted: true },
    { module: 'suppliers', action: 'write', granted: true }
  ],
  
  super_admin: [
    // ... incluye todos los permisos +
    { module: 'system', action: 'read', granted: true },
    { module: 'system', action: 'write', granted: true },
    { module: 'users', action: 'write', granted: true },
    { module: 'database', action: 'read', granted: true },
    { module: 'security', action: 'write', granted: true }
  ]
};
```

### Hooks de Autenticaci√≥n

```typescript
// Hook principal de autenticaci√≥n
export function useAuth() {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);
  
  const hasPermission = (module: string, action: string): boolean => {
    if (!user) return false;
    
    const rolePermissions = ROLE_PERMISSIONS[user.role];
    return rolePermissions.some(perm => 
      perm.module === module && 
      perm.action === action && 
      perm.granted
    );
  };
  
  const canAccess = (resource: string): boolean => {
    const [module, action = 'read'] = resource.split(':');
    return hasPermission(module, action);
  };
  
  const isRole = (role: UserRole): boolean => {
    return user?.role === role;
  };
  
  const isAtLeastRole = (role: UserRole): boolean => {
    if (!user) return false;
    
    const roleHierarchy: UserRole[] = [
      'cliente', 'operador', 'supervisor', 'administrador', 'super_admin'
    ];
    
    const userRoleIndex = roleHierarchy.indexOf(user.role);
    const requiredRoleIndex = roleHierarchy.indexOf(role);
    
    return userRoleIndex >= requiredRoleIndex;
  };
  
  return {
    user,
    loading,
    hasPermission,
    canAccess,
    isRole,
    isAtLeastRole,
    login,
    logout,
    updateProfile
  };
}
```

### Componentes de Protecci√≥n

```typescript
// Componente para proteger rutas
interface ProtectedRouteProps {
  children: React.ReactNode;
  requiredRole?: UserRole;
  requiredPermission?: string;
  fallback?: React.ReactNode;
}

export function ProtectedRoute({ 
  children, 
  requiredRole, 
  requiredPermission,
  fallback = <UnauthorizedPage />
}: ProtectedRouteProps) {
  const { user, isAtLeastRole, canAccess } = useAuth();
  
  if (!user) {
    return <LoginPage />;
  }
  
  if (requiredRole && !isAtLeastRole(requiredRole)) {
    return fallback;
  }
  
  if (requiredPermission && !canAccess(requiredPermission)) {
    return fallback;
  }
  
  return <>{children}</>;
}

// Componente para mostrar contenido condicionalmente
interface RoleGateProps {
  children: React.ReactNode;
  role?: UserRole;
  permission?: string;
  minRole?: UserRole;
}

export function RoleGate({ children, role, permission, minRole }: RoleGateProps) {
  const { isRole, canAccess, isAtLeastRole } = useAuth();
  
  if (role && !isRole(role)) return null;
  if (minRole && !isAtLeastRole(minRole)) return null;
  if (permission && !canAccess(permission)) return null;
  
  return <>{children}</>;
}
```

## üéØ Casos de Uso por Rol

### üõçÔ∏è Cliente - Experiencia de Compra
```typescript
function CustomerDashboard() {
  return (
    <div>
      <CustomerWelcome />
      <RecentOrders />
      <FavoriteProducts />
      <LoyaltyProgram />
      <OrderHistory />
    </div>
  );
}
```

### üë®‚Äçüç≥ Operador - Panel de Cocina
```typescript
function OperatorDashboard() {
  return (
    <ProtectedRoute requiredRole="operador">
      <div>
        <KitchenDisplay />
        <ActiveOrders />
        <RoleGate permission="sales:write">
          <BasicPOS />
        </RoleGate>
        <MySchedule />
      </div>
    </ProtectedRoute>
  );
}
```

### üë©‚Äçüíº Supervisor - Panel de Gesti√≥n
```typescript
function SupervisorDashboard() {
  return (
    <ProtectedRoute requiredRole="supervisor">
      <div>
        <DailyOperations />
        <TeamPerformance />
        <RoleGate permission="materials:write">
          <InventoryAlerts />
        </RoleGate>
        <MenuManagement />
        <TeamScheduling />
      </div>
    </ProtectedRoute>
  );
}
```

### üè¢ Administrador - Panel Ejecutivo
```typescript
function AdminDashboard() {
  return (
    <ProtectedRoute requiredRole="administrador">
      <div>
        <BusinessAnalytics />
        <FinancialReports />
        <RoleGate permission="staff:write_full">
          <StaffManagement />
        </RoleGate>
        <SupplierManagement />
        <BusinessSettings />
      </div>
    </ProtectedRoute>
  );
}
```

### üëë Super Admin - Panel del Sistema
```typescript
function SuperAdminDashboard() {
  return (
    <ProtectedRoute requiredRole="super_admin">
      <div>
        <SystemHealth />
        <UserManagement />
        <DatabaseManagement />
        <SecuritySettings />
        <FeatureFlags />
        <AuditLogs />
      </div>
    </ProtectedRoute>
  );
}
```

## üîí Seguridad y Mejores Pr√°cticas

### Validaci√≥n del Lado del Servidor
```typescript
// Middleware de validaci√≥n de permisos en el backend
export function requirePermission(module: string, action: string) {
  return async (req: Request, res: Response, next: NextFunction) => {
    const user = req.user; // Usuario autenticado
    
    if (!user) {
      return res.status(401).json({ error: 'No autenticado' });
    }
    
    const hasPermission = await checkUserPermission(user.id, module, action);
    
    if (!hasPermission) {
      return res.status(403).json({ error: 'Sin permisos suficientes' });
    }
    
    next();
  };
}

// Uso en rutas
app.get('/api/admin/users', 
  requireAuth,
  requirePermission('users', 'read'),
  getUsersController
);
```

### Principio de Menor Privilegio
- Los usuarios reciben solo los permisos m√≠nimos necesarios
- Los permisos se pueden escalar pero no degradar autom√°ticamente
- Revisi√≥n regular de permisos asignados

### Auditor√≠a de Acciones
```typescript
// Sistema de logging de acciones sensibles
export function logUserAction(userId: string, action: string, resource: string) {
  return db.insert('audit_logs', {
    user_id: userId,
    action,
    resource,
    timestamp: new Date(),
    ip_address: getClientIP(),
    user_agent: getUserAgent()
  });
}
```

## üìä Matriz de Permisos Completa

| M√≥dulo | Cliente | Operador | Supervisor | Admin | Super Admin |
|--------|---------|----------|------------|-------|-------------|
| **Customer Portal** | ‚úÖ R/W | ‚ùå | ‚ùå | üëÅÔ∏è R | üëÅÔ∏è R |
| **Operations** | ‚ùå | ‚úÖ R/W | ‚úÖ R/W | ‚úÖ R/W | ‚úÖ R/W |
| **Sales Basic** | üõí Own | ‚úÖ R/W | ‚úÖ R/W | ‚úÖ R/W | ‚úÖ R/W |
| **Sales Analytics** | ‚ùå | ‚ùå | üëÅÔ∏è Daily | ‚úÖ Full | ‚úÖ Full |
| **Materials** | ‚ùå | üëÅÔ∏è R | ‚úÖ Basic | ‚úÖ Full | ‚úÖ Full |
| **Products** | üëÅÔ∏è R | üëÅÔ∏è R | ‚úÖ R/W | ‚úÖ R/W | ‚úÖ R/W |
| **Staff** | ‚ùå | ‚ùå | ‚úÖ Basic | ‚úÖ Full | ‚úÖ Full |
| **Scheduling** | ‚ùå | üëÅÔ∏è Own | ‚úÖ Team | ‚úÖ Full | ‚úÖ Full |
| **Fiscal** | ‚ùå | ‚ùå | üëÅÔ∏è R | ‚úÖ R/W | ‚úÖ R/W |
| **Settings** | üë§ Profile | ‚ùå | ‚öôÔ∏è Basic | üè¢ Business | üîß System |
| **Users Management** | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚úÖ Full |
| **System Admin** | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚úÖ Full |

### Leyenda:
- ‚úÖ **Full**: Acceso completo (lectura y escritura)
- üëÅÔ∏è **R**: Solo lectura
- üõí **Own**: Solo sus propios datos
- ‚öôÔ∏è **Basic**: Funcionalidades b√°sicas
- üè¢ **Business**: Configuraciones de negocio
- üîß **System**: Configuraciones del sistema
- üë§ **Profile**: Solo perfil personal
- ‚ùå **No**: Sin acceso

## üîó Referencias

- **Authentication Service**: `src/lib/auth.ts`
- **Permission Definitions**: `src/types/permissions.ts`
- **Role Guards**: `src/components/auth/RoleGate.tsx`
- **Database Schema**: `database/migrations/001_user_roles.sql`
- **API Middleware**: `src/middleware/auth.ts`
